if(typeof de=="undefined"){de={}}if(typeof de.edirom=="undefined"){de.edirom={}}if(typeof de.edirom.server=="undefined"){de.edirom.server={}}if(typeof de.edirom.server.source=="undefined"){de.edirom.server.source={}}de.edirom.server.source.Module=Class.create(de.edirom.server.main.Module,{initialize:function($super){$super();this.preInitialize();if($("sourceId").value=="-1"){this.postInitialize()}else{var a=function(){this.postInitialize()}.bind(this);this.source=new de.edirom.server.data.Source($("sourceId").value,a)}},preInitialize:function(){this.ignoreNextCometUpdate=false;this.logger=new de.edirom.server.main.Logger("Source",3);this.indicator=new de.edirom.server.main.Indicator("ediromObject");this.shortcutController=new de.edirom.server.main.ShortcutController();this.shortcutController.addShortcutListener("module","module.source",this.shortcutListener.bind(this));this.controller=new de.edirom.server.main.CommandController();this.dropDown=new de.edirom.server.main.DropDown();this.saveAction=new de.edirom.server.main.SaveAction(this,this.toolbar,this.controller);this.undoAction=new de.edirom.server.main.UndoAction(this,this.toolbar,this.controller);this.redoAction=new de.edirom.server.main.RedoAction(this,this.toolbar,this.controller)},postInitialize:function(){$("loading").hide();this.addView(new de.edirom.server.source.InfoView(this,"Struktur"));if(typeof(this.source)!="undefined"){this.source.addListener(new de.edirom.server.data.DataListener(function(b){if(b.field=="name"){$("objectTitle").update(b.getValue());document.title=b.getValue()}}))}if($("sourceId").value=="-1"){$("objectID").innerHTML="";this.toolbar.hide()}else{this.facsimile=new de.edirom.server.source.FacsimileView(this,"Facsimile");this.addView(this.facsimile);this.xmlView=new de.edirom.server.source.XMLView(this,"XML");this.addView(this.xmlView);de.edirom.server.main.registerCometListener(this.cometUpdate.bind(this),function(){});if(window.location.search.indexOf("showPage=")!=-1){var a=window.location.search;a=a.substr(a.indexOf("showPage=")+"showPage=".length);if(a.indexOf("&")!=-1){a=a.substring(0,a.indexOf("&"))}this.showPage(a)}if(window.location.search.indexOf("openXMLView")!=-1){this.showXMLPage(null)}}},shortcutListener:function(a){return false},getSource:function(){return this.source},getCommandController:function(){return this.controller},getIndicator:function(){return this.indicator},getShortcutController:function(){return this.shortcutController},getFacsimileView:function(){return this.facsimile},doSave:function(){this.indicator.addJob("save","Saving");if(!this.controller.unsavedCommands()){return}var a='let $mei := collection("/db/contents/sources")//source/id("'+$("sourceId").value+'")/root() return (# exist:batch-transaction #) {'+this.controller.getXQueryUpdates()+"}";$("toolbar_save_dirty").addClassName("saving");$("loading").innerHTML="<span>Quelle wird gespeichert</span>";$("loading").show();this.ignoreNextCometUpdate=true;new Ajax.Request("../data/xql/saveObject.xql",{method:"post",parameters:{updates:a,namespace:"http://www.edirom.de/ns/mei"},onSuccess:function(b){$("toolbar_save_dirty").removeClassName("saving");$("loading").hide();window.status="edirom:closeAfterSave";this.indicator.jobFinished("save")}.bind(this),onFailure:function(b){console.log("Quelle konnte nicht gespeichert werden: \n\n"+b.responseText);this.indicator.jobFinished("save")}.bind(this)})},doUndo:function(){this.controller.undoCommand()},doRedo:function(){this.controller.redoCommand()},doDropDown:function(){var a=this.controller.getCommandList();return a},showPage:function(a){this.setActiveView(this.facsimile);this.facsimile.showPage(a)},showXMLPage:function(a){this.setActiveView(this.xmlView,a)},cometUpdate:function(c){if(c.length==0){return}var d=c.split(":");if(d[1].endsWith(".xml")){d[1]=d[1].substring(0,d[1].length-".xml".length)}if(d[1]!=$("sourceId").value){return}if(this.ignoreNextCometUpdate){this.ignoreNextCometUpdate=false;return}if(d[0]=="removed"){var b="Der Notentext ist in der Datenbank gelöscht worden. Das Fenster wird nun geschlossen.";var a={firstButton:"Ok",firstFunc:"window.status = 'edirom:de.edirom.server:closeWindow'",secondButtonVisible:"false"};(new de.edirom.server.main.Popup(b,a)).showPopup()}else{if(d[0]=="modified"){if(this.xmlView.active){this.checkTitle();this.funcBeforeViewSwitch=function(){this.updateAfterComet()}.bind(this);return}var b="Der Notentext ist entweder in der XML-Ansicht oder in der Datenbank geändert worden. Die Inhalte werden nun neu geladen.";var a={firstButton:"Ok",firstFunc:function(){this.updateAfterComet()}.bind(this),secondButtonVisible:"false"};(new de.edirom.server.main.Popup(b,a)).showPopup()}}},updateAfterComet:function(){window.location="index.xql?id="+$("sourceId").value},checkTitle:function(){new Ajax.Request("../data/xql/getSourceTitle.xql",{method:"get",parameters:{id:$("sourceId").value},onSuccess:function(a){if(this.source.getName()!=a.responseText){$("objectTitle").update(a.responseText);document.title=a.responseText}}.bind(this)})}});document.observe("dom:loaded",function(){window.module=new de.edirom.server.source.Module()});function onElementFocussed(a){if(a&&a.target){window.elementWithFocus=a.target==document?null:a.target}}if(document.addEventListener){document.addEventListener("focus",onElementFocussed,true)}de.edirom.server.source.Bars=Class.create(de.edirom.server.main.Content,{initialize:function($super,a){$super(a,"content_source_informationView_bars");this.toolbarGroup=a.toolbarGroup;this.barCountAction=new de.edirom.server.source.BarCountAction(this.toolbarGroup,this);this.barCountToolbarItem=new de.edirom.server.source.BarCountToolbarItem(this.toolbarGroup,this.barCountAction);this.barCountToolbarItem.setVisible(false)},load:function($super){if(!this.isLoaded()){new Ajax.Updater(this.id,"/source/InformationView/xql/bars.xql",{method:"get",onComplete:function(a){$super();this.init()}.bind(this)})}},init:function(){var b=this.view.getModule().getSource();var a=b.getMovements();this.sortOrder=new Hash();a.each(function(e){var g=$("movementHeading_template");var i=g.cloneNode(true);i.setAttribute("id","heading_"+e.id);i.update(e.getName());i.show();var d=$("table_barsPerMov_template");var h=d.cloneNode(true);h.setAttribute("id","table_"+e.id);h.show();var f=h.getElementsByClassName("bars_listBody")[0];f.setAttribute("id","bars_"+e.id);$("barsTables").appendChild(i);$("barsTables").appendChild(h);var c=e.getBars();c.each(function(j){this.addBar(f,j)}.bind(this))}.bind(this));this.scrollview=new de.edirom.server.Scrollview("barsTables",true);this.scrollview.setVerticalScrolling(true);a.each(function(d){var e=$("bars_"+d.id);this.buildSortableList(e);this.addMovementListeners(d);var c=d.getBars();c.each(function(f){this.addBarListeners(f)}.bind(this))}.bind(this));if(this.scrollview){this.scrollview.refresh()}this.addListeners()},addMovementListeners:function(a){a.addListener(new de.edirom.server.data.DataListener(function(e,b){if(e.type==de.edirom.server.data.DataEvent.TYPE_REMOVED&&e.field=="bar"){$("bars_"+b).removeChild($("row_"+e.getValue()));this.buildSortableList($("bars_"+b));if(this.scrollview){this.scrollview.refresh()}}else{if(e.type==de.edirom.server.data.DataEvent.TYPE_ADDED&&e.field=="bar"){var d=e.getSource().getBar(e.getValue());this.addBar($("bars_"+b),d);this.addBarListeners(d);this.buildSortableList($("bars_"+b));if(this.scrollview){this.scrollview.refresh()}}else{if(e.type==de.edirom.server.data.DataEvent.TYPE_MODIFIED&&e.field=="bars"){var d=$("row_"+e.getValue());$("bars_"+b).removeChild(d);var c=e.getSource().getBarAfter(e.getValue())==null?null:$("row_"+e.getSource().getBarAfter(e.getValue()).id);$("bars_"+b).insertBefore(d,c);this.buildSortableList($("bars_"+b))}}}}.bindAsEventListener(this,a.id)))},addBar:function(a,c){var d=this.view.getModule().getSource();var b=$("row_bars_template");var f=b.cloneNode(true);f.setAttribute("id","row_"+c.id);f.getElementsByClassName("openButton")[0].setAttribute("id","open_"+c.id);f.getElementsByClassName("openXMLButton")[0].setAttribute("id","openXML_"+c.id);f.getElementsByClassName("deleteButton")[0].setAttribute("id","delete_"+c.id);f.getElementsByClassName("bars_name_input")[0].setAttribute("id",c.id);f.getElementsByClassName("bars_name_input")[0].setAttribute("value",c.getName());f.getElementsByClassName("movement")[0].innerHTML=d.getMovement(c.getPartId()).getName();f.getElementsByClassName("page")[0].innerHTML=d.getPage(c.getSurface()).getName();f.getElementsByClassName("upbeat")[0].checked=c.getUpbeat();f.getElementsByClassName("upbeat")[0].setAttribute("id","upbeat_"+c.id);var e=c.getRest();if(e>0){f.getElementsByClassName("pause")[0].checked=true;f.getElementsByClassName("measureCount")[0].setAttribute("value",e)}f.getElementsByClassName("pause")[0].setAttribute("id","pause_"+c.id);f.getElementsByClassName("measureCount")[0].setAttribute("id","measureCount_"+c.id);a.appendChild(f)},addBarListeners:function(b){var a=this.view.getModule().getCommandController();var c=this.view.getModule().getSource();Event.observe($(b.id),"keyup",function(e,d){window.setTimeout(this.inputFieldChanged.bind(this,d,b,"name",$(b.id).value,b.id),600)}.bindAsEventListener(this,a,c));Event.observe($("open_"+b.id),"click",function(d){module.showPage(b.getSurface())});Event.observe($("openXML_"+b.id),"click",function(d){module.showXMLPage(b.id)});Event.observe($("delete_"+b.id),"click",function(e,h,i){var d=this;var j=d.getBar(i);var f=d.getMovement(j.getPartId());var k=d.getPage(j.getSurface());var g=function(){h.addCommand(new de.edirom.server.main.RemoveObjectCommand(f,"bars",j));new Ajax.Request("../source/xql/deleteBarReferencesInWorks.xql",{method:"post",parameters:{sourceID:d.id,measureID:j.id}})}.bind(this);var l="Takt löschen";var n='Wenn Sie Takt "'+j.getName()+'" löschen, werden dadurch automatisch in allen Werken, die "'+d.getName()+'" referenzieren, die Verweise auf diesen Takt aufgehoben. Dies betrifft sowohl Taktkonkordanz als auch Anmerkungen.';var m={firstButton:"Abbrechen",secondButton:"Takt löschen",secondFunc:g};(new de.edirom.server.main.Popup(n,m,l)).showPopup()}.bindAsEventListener(c,a,b.id));b.addListener(new de.edirom.server.data.DataListener(function(e){var d=e.getSource();var g=$("row_"+d.id);if(e.field=="name"){$(d.id).value=e.getValue()}else{if(e.field=="partId"){g.getElementsByClassName("movement")[0].innerHTML=c.getMovement(d.getPartId()).getName()}else{if(e.field=="rest"){var f=d.getRest();if(f>0){g.getElementsByClassName("pause")[0].checked=true;g.getElementsByClassName("measureCount")[0].setAttribute("value",f)}}else{if(e.field=="upbeat"){g.getElementsByClassName("upbeat")[0].checked=d.getUpbeat()}}}}}))},addListeners:function(){Event.observe($("selectAllBars"),"click",this.selectAllBars.bind(this))},buildSortableList:function(a){Sortable.create(a.identify(),{elements:$$("#"+a.identify()+" tr"),handle:"moveButton",ghosting:true,tag:"tr",treetag:"tbody",format:/^row_(.*)$/,onUpdate:this.sortOrderUpdated.bind(this,a)});this.sortOrder.set(a.identify(),Sortable.sequence(a.identify()))},sortOrderUpdated:function(g){var b=Sortable.sequence(g.identify());if(de.edirom.areArraysEqual(b,this.sortOrder.get(g.identify()))){return}var d="";var k="";for(var f=0;f<this.sortOrder.get(g.identify()).length;f++){var e=b.indexOf(this.sortOrder.get(g.identify())[f]);if(f!=e&&f!=e+1&&f!=e-1){d=this.sortOrder.get(g.identify())[f];k=(e==0)?null:b[e-1];break}}if(d==""){for(var f=0;f<this.sortOrder.get(g.identify()).length;f++){var e=b.indexOf(this.sortOrder.get(g.identify())[f]);if(f!=e){d=this.sortOrder.get(g.identify())[f];k=(e==0)?null:b[e-1];break}}}this.sortOrder.set(g.identify(),b);var a=this.view.getModule().getSource();var h=this.view.getModule().getCommandController();var c=a.getMovement(g.identify().substring(5));h.addCommand(new de.edirom.server.main.MoveObjectCommand(c,"bars",d,k))},importBars:function(){alert("Evtl. zur Integration der automatischen Vertaktung…?")},inputFieldChanged:function(b,c,e,d,a){if(typeof this.inputFieldChanges=="undefined"){this.inputFieldChanges=new Array()}if(typeof this.inputFieldChanges[e]=="undefined"){this.inputFieldChanges[e]="undefined"}if(this.inputFieldChanges[e]!=d&&$(a).value==d){b.addCommand(new de.edirom.server.main.ChangeFieldCommand(c,e,d));this.inputFieldChanges[e]=d}},selectAllBars:function(){var b=$$(".selectBar");var a=true;b.each(function(c){if(!c.checked){a=false;throw $break}});if(!a){b.each(function(c){c.checked=true})}else{b.each(function(c){c.checked=false})}},changeBarNumbers:function(d){var c=this.view.getModule().getSource();var b=$$(".bars_listBody tr");var e=new de.edirom.server.main.GroupCommand();b.each(function(g){if(g.getElementsByClassName("selectBar")[0].checked){var f=c.getBar(g.id.substring(4));var h=f.changeBarNumber(d);e.addGroupCommand(new de.edirom.server.main.ChangeFieldCommand(f,"name",h))}});if(e.getLength()==0){return}var a=this.view.getModule().getCommandController();a.addCommand(e)},setVisible:function($super,a){$super(a);this.barCountToolbarItem.setVisible(a);if(this.scrollview){this.scrollview.refresh()}}});de.edirom.server.source.BarCountToolbarItem=Class.create(de.edirom.server.main.ToolbarItem,{initialize:function($super,a,b){$super(a);this.action=b;$(this.id).insert({bottom:'<div class="toolbarSpacer"></div><div class="toolbarPressButton" id="toolbar_countBarsUp">+1</div><div class="toolbarPressButton" id="toolbar_countBarsDown">-1</div>'});Event.observe($("toolbar_countBarsUp"),"click",b.countBarsUp.bindAsEventListener(b));Event.observe($("toolbar_countBarsDown"),"click",b.countBarsDown.bindAsEventListener(b))}});de.edirom.server.source.BarCountAction=Class.create(de.edirom.server.main.Action,{initialize:function($super,b,a){$super();this.barsJS=a},countBarsUp:function(){this.barsJS.changeBarNumbers(1)},countBarsDown:function(){this.barsJS.changeBarNumbers(-1)}});de.edirom.server.source.Description=Class.create(de.edirom.server.main.Content,{initialize:function($super,a){$super(a,"content_source_informationView_description")},load:function($super){if(!this.isLoaded()){new Ajax.Updater(this.id,"/source/InformationView/xql/description.xql",{method:"get",onComplete:function(a){$super();this.init()}.bind(this)})}},init:function(){this.source=this.view.getModule().getSource();this.texts=this.source.getTexts();for(var a=0;a<this.texts.length;a++){this.addText(this.texts[a])}this.addListeners();this.buildSortableList()},addText:function(d){var c=$("row_text_template").cloneNode(true);c.setAttribute("id","row_"+d.id);c.getElementsByClassName("openButton")[0].setAttribute("id","open_"+d.id);c.getElementsByClassName("openXMLButton")[0].setAttribute("id","openXML_"+d.id);c.getElementsByClassName("deleteButton")[0].setAttribute("id","delete_"+d.id);c.getElementsByClassName("texts_name_input")[0].setAttribute("id",d.id);c.getElementsByClassName("texts_name_input")[0].value=d.getTitle();c.getElementsByClassName("texts_id_input")[0].setAttribute("id","textID_"+d.id);c.getElementsByClassName("texts_id_input")[0].setAttribute("value",d.id);var b=$("texts_listBody");b.appendChild(c);Event.observe($("open_"+d.id),"click",function(e){window.open("/text/index.xql?id="+d.id,"text_"+(new Date()).getTime())});Event.observe($("openXML_"+d.id),"click",function(e){window.open("/text/index.xql?id="+d.id+"&openXMLView","text_"+(new Date()).getTime())});var a=this.view.getModule().getCommandController();Event.observe($("delete_"+d.id),"click",function(f,e,g){e.addCommand(new de.edirom.server.main.RemoveObjectCommand(this,"texts",g))}.bindAsEventListener(source,a,d.id));Event.observe($("delete_"+d.id),"click",this.removeText.bindAsEventListener(this,this.source,d,a));d.addListener(new de.edirom.server.data.DataListener(function(e){var g=e.getText();var f=$("row_"+g.id);if(e.field=="name"){$(g.id).value=e.getValue()}}))},removeText:function(b,c,e,a){var d=new de.edirom.server.main.GroupCommand();d.addGroupCommand(new de.edirom.server.main.RemoveObjectCommand(this.source,"texts",e.id));a.addCommand(d)},addListeners:function(){this.source.addListener(new de.edirom.server.data.DataListener(function(b){if(b.type==de.edirom.server.data.DataEvent.TYPE_REMOVED&&b.field=="text"){this.texts=this.source.getTexts();$("texts_listBody").removeChild($("row_"+b.getValue()));this.buildSortableList()}else{if(b.type==de.edirom.server.data.DataEvent.TYPE_ADDED&&b.field=="text"){this.texts=this.source.getTexts();this.addText(b.getSource().getText(b.getValue()));this.buildSortableList()}else{if(b.type==de.edirom.server.data.DataEvent.TYPE_MODIFIED&&b.field=="text"){var c=$("row_"+b.getValue());$("texts_listBody").removeChild(c);var a=b.getSource().getTextAfter(b.getValue())==null?null:$("row_"+b.getSource().getPageAfter(b.getValue()).id);$("texts_listBody").insertBefore(c,a);this.buildSortableList()}}}}.bind(this)));Event.observe($("import_description"),"click",this.importTexts.bind(this))},buildSortableList:function(){Sortable.create("texts_listBody",{elements:$$("#texts_listBody tr"),handle:"moveButton",ghosting:true,tag:"tr",treetag:"tbody",format:/^row_(.*)$/,onUpdate:this.sortOrderUpdated.bind(this)});this.sortOrder=Sortable.sequence("texts_listBody")},sortOrderUpdated:function(){var d=Sortable.sequence("texts_listBody");var f="";var e="";for(var c=0;c<this.sortOrder.length;c++){var b=d.indexOf(this.sortOrder[c]);if(c!=b&&c!=b+1&&c!=b-1){f=this.sortOrder[c];e=(b==0)?null:d[b-1];break}}if(f==""){for(var c=0;c<this.sortOrder.length;c++){var b=d.indexOf(this.sortOrder[c]);if(c!=b){f=this.sortOrder[c];e=(b==0)?null:d[b-1];break}}}var a=this.view.getModule().getCommandController();a.addCommand(new de.edirom.server.main.MoveObjectCommand(this.source,"texts",f,e))},importTexts:function(){var c=["texts"];var b=new Array();b.clear();var a=this.view.getModule().getCommandController();this.texts.each(function(e){b.push(e.id)});var d=function(f){var k=new Array();var e=new Array();for(var h=0;h<f.length;h++){if(!b.include(f[h])){k.push(f[h])}}for(var g=0;g<b.length;g++){if(!f.include(b[g])){e.push(b[g])}}k.each(function(l){var i=function(m){a.addCommand(new de.edirom.server.main.AddObjectCommand(this.source,"texts",m))}.bind(this);var j=new de.edirom.server.data.Text(l,i)}.bind(this));e.each(function(i){this.removeText(null,this.source,this.source.getText(i),a)}.bind(this))}.bind(this);new de.edirom.server.main.ObjectPicker(c,b,d,"radio")},inputFieldChanged:function(b,c,e,d,a){if(typeof this.inputFieldChanges=="undefined"){this.inputFieldChanges=new Array()}if(typeof this.inputFieldChanges[e]=="undefined"){this.inputFieldChanges[e]="undefined"}if(this.inputFieldChanges[e]!=d&&$(a).value==d&&c.getField(e)!=d){b.addCommand(new de.edirom.server.main.ChangeFieldCommand(c,e,d));this.inputFieldChanges[e]=d}},setVisible:function($super,a){$super(a);if(a){this.view.module.getShortcutController().addShortcutListener("content","content.texts",function(b){return false})}else{this.view.module.getShortcutController().removeShortcutListener("content","content.texts")}}});de.edirom.server.source.InfoView=Class.create(de.edirom.server.main.View,{initialize:function($super,a,b){$super(a,b);this.toolbarGroup=new de.edirom.server.main.ToolbarGroup(a.toolbar);this.toolbarGroup.setVisible(false);if($("sourceId").value=="-1"){this.addContentWithTab(new de.edirom.server.source.Overview(this),"Übersicht");this.tabBar.hide()}else{a.getShortcutController().addShortcutListener("view","view.information",this.shortcutListener.bind(this));this.addContentWithTab(new de.edirom.server.source.Overview(this),"Übersicht");this.addContentWithTab(new de.edirom.server.source.Pages(this),"Seiten");this.addContentWithTab(new de.edirom.server.source.Structure(this),"Struktur");this.addContentWithTab(new de.edirom.server.source.Bars(this),"Takte");this.addContentWithTab(new de.edirom.server.source.Description(this),"Beschreibung")}},setActive:function($super,a){$super(a);this.toolbarGroup.setVisible(a);if(a){this.tabBar.show();this.module.getShortcutController().addShortcutListener("view","view.information",this.shortcutListener.bind(this))}else{this.module.getShortcutController().removeShortcutListener("view","view.information")}},shortcutListener:function(b){var a=(navigator.userAgent.indexOf("Macintosh")!=-1);if(b.which==83&&((a&&b.metaKey)|(!a&&b.ctrlKey))){this.module.doSave();return true}return false}});de.edirom.server.source.Overview=Class.create(de.edirom.server.main.Content,{buttonEnabled:true,initialize:function($super,a){$super(a,"content_source_informationView_overview")},load:function($super){if(!this.isLoaded()){new Ajax.Updater(this.id,"/source/InformationView/xql/overview.xql",{method:"get",onComplete:function(a){$super();this.init()}.bind(this)})}},init:function(){this.scrollview=new de.edirom.server.Scrollview("structure_container",true);this.scrollview.setVerticalScrolling(true);if($("sourceId").value=="-1"){$("saveBox").show();Event.observe($("sourceDatingInput"),"keyup",function(c){$("inputValidationFeedback").innerHTML=""});Event.observe($("workInput"),"keyup",function(c){$("inputValidationFeedback").innerHTML=""});Event.observe($("composerInput"),"keyup",function(c){$("inputValidationFeedback").innerHTML=""});Event.observe($("nameInput"),"keyup",function(c){$("inputValidationFeedback").innerHTML=""});Event.observe($("sourceSignatureInput"),"keyup",function(c){$("inputValidationFeedback").innerHTML=""});Event.observe($("cancelButton"),"click",function(c){if(this.buttonEnabled){window.status="edirom:de.edirom.server:closeWindow"}}.bindAsEventListener(this));Event.observe($("saveButton"),"click",function(c){if(this.buttonEnabled){this.buttonEnabled=false;this.createNewSource()}}.bindAsEventListener(this))}else{var b=this.view.getModule().getSource();$("workInput").value=b.getWorkName();$("composerInput").value=b.getComposer();$("nameInput").value=b.getName();$("sourceSignatureInput").value=b.getSignature();$("sourceDatingInput").value=b.getDating();for(var a=0;a<$("sourceTypeInput").length;a++){if($("sourceTypeInput").options[a].value==b.getType()){$("sourceTypeInput").selectedIndex=a}}this.addListeners()}},addListeners:function(){var b=this.view.getModule().getSource();var a=this.view.getModule().getCommandController();b.addListener(new de.edirom.server.data.DataListener(function(c){if(c.field=="name"){$("nameInput").value=c.getValue()}else{if(c.field=="signature"){$("sourceSignatureInput").value=c.getValue()}else{if(c.field=="composer"){$("composerInput").value=c.getValue()}else{if(c.field=="workName"){$("workInput").value=c.getValue()}else{if(c.field=="dating"){$("sourceDatingInput").value=c.getValue()}else{if(c.field=="type"){$("sourceTypeInput").selectedIndex.value=c.getValue()}}}}}}}));Event.observe($("sourceSignatureInput"),"keyup",function(d,c,e){window.setTimeout(this.inputFieldChanged.bind(this,c,e,"signature",$("sourceSignatureInput").value,"sourceSignatureInput"),600)}.bindAsEventListener(this,a,b));Event.observe($("nameInput"),"keyup",function(d,c,e){window.setTimeout(this.inputFieldChanged.bind(this,c,e,"name",$("nameInput").value,"nameInput"),600)}.bindAsEventListener(this,a,b));Event.observe($("composerInput"),"keyup",function(d,c,e){window.setTimeout(this.inputFieldChanged.bind(this,c,e,"composer",$("composerInput").value,"composerInput"),600)}.bindAsEventListener(this,a,b));Event.observe($("workInput"),"keyup",function(d,c,e){window.setTimeout(this.inputFieldChanged.bind(this,c,e,"workname",$("workInput").value,"workInput"),600)}.bindAsEventListener(this,a,b));Event.observe($("sourceDatingInput"),"keyup",function(d,c,e){window.setTimeout(this.inputFieldChanged.bind(this,c,e,"dating",$("sourceDatingInput").value,"sourceDatingInput"),600)}.bindAsEventListener(this,a,b));Event.observe($("sourceTypeInput"),"change",function(d,c,e){c.addCommand(new de.edirom.server.main.ChangeFieldCommand(e,"type",$("sourceTypeInput").options[$("sourceTypeInput").selectedIndex].value))}.bindAsEventListener(this,a,b))},inputFieldChanged:function(b,c,e,d,a){if(typeof this.inputFieldChanges=="undefined"){this.inputFieldChanges=new Array()}if(typeof this.inputFieldChanges[e]=="undefined"){this.inputFieldChanges[e]="undefined"}if(this.inputFieldChanges[e]!=d&&$(a).value==d&&c.getField(e)!=d){b.addCommand(new de.edirom.server.main.ChangeFieldCommand(c,e,d));this.inputFieldChanges[e]=d}},createNewSource:function(){var b=$("workInput").value.trim();var d=$("composerInput").value.trim();var c=$("nameInput").value.trim();var a=$("sourceSignatureInput").value.trim();var f=$("sourceDatingInput").value.trim();var e=$("sourceTypeInput").options[$("sourceTypeInput").selectedIndex].value;if(b.blank()&&d.blank()&&c.blank()&&a.blank()){$("inputValidationFeedback").innerHTML="Werk, Komponist, Bezeichnung oder Signatur erforderlich.";this.buttonEnabled=true;return}new Ajax.Request("../data/xql/createSource.xql",{method:"get",parameters:{fields:"workInput__%__composerInput__%__nameInput__%__sourceSignatureInput__%__sourceDatingInput__%__sourceTypeInput",values:b+"__%__"+d+"__%__"+c+"__%__"+a+"__%__"+f+"__%__"+e},onSuccess:function(h){var g=h.responseText;if(g.indexOf("ERROR")!=-1){alert("Quelle konnte nicht angelegt werden: \n\n"+h.responseText)}else{window.location.href="/source/index.xql?id="+g}}.bind(this),onFailure:function(g){alert("Quelle konnte nicht angelegt werden: \n\n"+g.responseText)}})},setVisible:function($super,a){$super(a);if(a){this.view.module.getShortcutController().addShortcutListener("content","content.overview",function(b){return false})}else{this.view.module.getShortcutController().removeShortcutListener("content","content.overview")}if(this.scrollview){this.scrollview.refresh()}}});de.edirom.server.source.Pages=Class.create(de.edirom.server.main.Content,{initialize:function($super,a){$super(a,"content_source_informationView_pages");this.toolbarGroup=a.toolbarGroup;this.renamePagesAction=new de.edirom.server.source.RenamePagesAction(this.toolbarGroup,this);this.pagesToolbarItem=new de.edirom.server.source.RenamePagesToolbarItem(this.toolbarGroup,this.renamePagesAction);this.pagesToolbarItem.setVisible(false)},load:function($super){if(!this.isLoaded()){new Ajax.Updater(this.id,"/source/InformationView/xql/pages.xql",{method:"get",onComplete:function(a){$super();this.init()}.bind(this)})}},init:function(){var c=this.view.getModule().getSource();var a=c.getPages();for(var b=0;b<a.length;++b){this.addPage(a[b])}this.scrolltable=new de.edirom.server.Scrolltable("pages_list_container","pages_list",true);this.scrolltable.setVerticalScrolling(true);for(var b=0;b<a.length;++b){this.addPageListeners(a[b])}this.addListeners();this.buildSortableList()},addPage:function(c){var a=$("pages_listBody");var b=$("row_page_template");var d=b.cloneNode(true);d.setAttribute("id","row_"+c.id);d.getElementsByClassName("openButton")[0].setAttribute("id","open_"+c.id);d.getElementsByClassName("openXMLButton")[0].setAttribute("id","openXML_"+c.id);d.getElementsByClassName("deleteButton")[0].setAttribute("id","delete_"+c.id);d.getElementsByClassName("pages_name_input")[0].setAttribute("id",c.id);d.getElementsByClassName("pages_name_input")[0].setAttribute("value",c.getName());d.getElementsByClassName("imageScale")[0].innerHTML=c.getWidth()+" x "+c.getHeight();d.getElementsByClassName("imageFileName")[0].innerHTML=c.getFileName();d.getElementsByClassName("imageDate")[0].innerHTML=c.getDate();d.getElementsByClassName("imageUri")[0].setAttribute("value",c.getPath());d.getElementsByClassName("imageUri")[0].setAttribute("id","imageUri_"+c.id);a.appendChild(d);if(this.scrolltable){this.scrolltable.refresh(0,1000000)}},addPageListeners:function(b){var a=this.view.getModule().getCommandController();Event.observe($(b.id),"keyup",function(d,c){window.setTimeout(this.inputFieldChanged.bind(this,c,b,"name",$(b.id).value,b.id),600)}.bindAsEventListener(this,a,b.id));Event.observe($("open_"+b.id),"click",function(d,c){module.showPage(c)}.bindAsEventListener(this,b.id));Event.observe($("openXML_"+b.id),"click",function(d,c){module.showXMLPage(c)}.bindAsEventListener(this,b.id));Event.observe($("delete_"+b.id),"click",this.deletePage.bindAsEventListener(this,source,b,a));b.addListener(new de.edirom.server.data.DataListener(function(c){var d=c.getSource();var e=$("row_"+d.id);if(c.field=="name"){$(d.id).value=c.getValue()}else{if(c.field=="width"||c.field=="height"){e.getElementsByClassName("imageScale")[0].innerHTML=d.getWidth()+" x "+d.getHeight()}else{if(c.field=="fileName"){e.getElementsByClassName("imageFileName")[0].innerHTML=d.getFileName()}else{if(c.field=="imageDate"){e.getElementsByClassName("imageDate")[0].innerHTML=d.getDate()}}}}}))},inputFieldChanged:function(b,c,e,d,a){if(typeof this.inputFieldChanges=="undefined"){this.inputFieldChanges=new Array()}if(typeof this.inputFieldChanges[a+"_"+e]=="undefined"){this.inputFieldChanges[a+"_"+e]="undefined"}if(this.inputFieldChanges[a+"_"+e]!=d&&$(a).value==d&&c.getField(e)!=d){b.addCommand(new de.edirom.server.main.ChangeFieldCommand(c,e,d));this.inputFieldChanges[a+"_"+e]=d}},addListeners:function(){var a=this.view.getModule().getSource();a.addListener(new de.edirom.server.data.DataListener(function(c){if(c.type==de.edirom.server.data.DataEvent.TYPE_REMOVED&&c.field=="page"){$("pages_listBody").removeChild($("row_"+c.getValue()));this.buildSortableList()}else{if(c.type==de.edirom.server.data.DataEvent.TYPE_ADDED&&c.field=="page"){var d=c.getSource().getPage(c.getValue());this.addPage(d);this.addPageListeners(d);this.buildSortableList()}else{if(c.type==de.edirom.server.data.DataEvent.TYPE_MODIFIED&&c.field=="page"){var d=$("row_"+c.getValue());$("pages_listBody").removeChild(d);var b=c.getSource().getPageAfter(c.getValue())==null?null:$("row_"+c.getSource().getPageAfter(c.getValue()).id);$("pages_listBody").insertBefore(d,b);this.buildSortableList()}}}}.bind(this)));Event.observe($("import_pages"),"click",this.importPages.bind(this))},buildSortableList:function(){Sortable.create("pages_listBody",{elements:$$("#pages_listBody tr"),handle:"moveButton",ghosting:true,tag:"tr",treetag:"tbody",format:/^row_(.*)$/,onUpdate:this.sortOrderUpdated.bind(this)});this.sortOrder=Sortable.sequence("pages_listBody")},sortOrderUpdated:function(){var e=Sortable.sequence("pages_listBody");if(de.edirom.areArraysEqual(e,this.sortOrder)){return}var b="";var f="";for(var d=0;d<this.sortOrder.length;d++){var c=e.indexOf(this.sortOrder[d]);if(d!=c&&d!=c+1&&d!=c-1){b=this.sortOrder[d];f=(c==0)?null:e[c-1];break}}if(b==""){for(var d=0;d<this.sortOrder.length;d++){var c=e.indexOf(this.sortOrder[d]);if(d!=c){b=this.sortOrder[d];f=(c==0)?null:e[c-1];break}}}this.sortOrder=e;var g=this.view.getModule().getSource();var a=this.view.getModule().getCommandController();a.addCommand(new de.edirom.server.main.MoveObjectCommand(g,"pages",b,f))},importPages:function(){window.status="edirom:de.edirom.server.source:openFilePicker?type=file&amp;filter=images,archives"},deletePage:function(b,a,j,h){var c=j.getBarIDs();if(c.length>0){var g=new de.edirom.server.main.GroupCommand();var l=a.getBarsSorted(c);for(var f=l.length-1;f>=0;f--){var d=a.getMovement(l[f].getPartId());g.addGroupCommand(new de.edirom.server.main.RemoveObjectCommand(d,"bars",l[f]))}g.addGroupCommand(new de.edirom.server.main.RemoveObjectCommand(a,"pages",j));var e=function(){h.addCommand(g);new Ajax.Request("../source/xql/deletePageReferencesInWorks.xql",{method:"post",parameters:{sourceID:a.id,pageID:j.id}})}.bind(this);var k="Seite löschen";var n='Wenn Sie Seite "'+j.getName()+'" löschen, werden gleichzeitig '+c.length+" darauf enthaltene Takte gelöscht.";var m={firstButton:"Abbrechen",secondButton:"Seite löschen",secondFunc:e};(new de.edirom.server.main.Popup(n,m,k)).showPopup()}else{h.addCommand(new de.edirom.server.main.RemoveObjectCommand(a,"pages",j))}},setVisible:function($super,a){$super(a);this.pagesToolbarItem.setVisible(a);if(a){this.view.module.getShortcutController().addShortcutListener("content","content.pages",function(b){return false})}else{this.view.module.getShortcutController().removeShortcutListener("content","content.pages")}if(this.scrolltable){this.scrolltable.refresh()}},renamePages:function(){var e=this.view.getModule().getSource();var a=e.getPages();var c=this.view.getModule().getCommandController();var f=new de.edirom.server.main.GroupCommand();for(var d=0;d<a.length;d++){var b=$$("#pages_listBody tr").indexOf($("row_"+a[d].id))+1;if(a[d].getName()!=b){f.addGroupCommand(new de.edirom.server.main.ChangeFieldCommand(a[d],"name",b));if(typeof this.inputFieldChanges=="undefined"){this.inputFieldChanges=new Array()}if(typeof this.inputFieldChanges[a[d].id+"_name"]=="undefined"){this.inputFieldChanges[a[d].id+"_name"]="undefined"}this.inputFieldChanges[a[d].id+"_name"]=b}}if(f.getLength()>0){c.addCommand(f)}}});de.edirom.server.source.importImage=function(f,j,d,i){var e="edirom_image_"+Math.uuid().toLowerCase();new Ajax.Request("../data/xql/createImage.xql",{method:"get",parameters:{id:e,path:j,pathOrig:f,width:d,height:i},onSuccess:function(k){}.bind(this),onFailure:function(k){console.log("Bilddaten konnten nicht abgelegt werden: \n\n"+k.responseText)}});var b=de.edirom.server.source.generatePageNo();var c="edirom_surface_"+Math.uuid().toLowerCase();var g=new de.edirom.server.data.Page(c,b,d,i,f,"",j,"xmldb:exist:///db/contents/images/"+e+".xml");var h=window.module.getCommandController();var a=window.module.getSource();h.addCommand(new de.edirom.server.main.AddObjectCommand(a,"pages",g))};de.edirom.server.source.startImageImportJob=function(){window.module.getIndicator().addJob("importImagesJob","Importiere Bilder…")};de.edirom.server.source.updateImageImportJob=function(a){window.module.getIndicator().setJobDescription("importImagesJob",a)};de.edirom.server.source.finishImageImportJob=function(){window.module.getIndicator().jobFinished("importImagesJob")};de.edirom.server.source.generatePageNo=function(){var b=$$("input.pages_name_input");var a=0;for(var c=0;c<b.length;c++){if(!isNaN($(b[c]).value)&&parseInt($(b[c]).value)>a){a=parseInt($(b[c]).value)}}return(a+1)};de.edirom.server.source.RenamePagesToolbarItem=Class.create(de.edirom.server.main.ToolbarItem,{initialize:function($super,a,b){$super(a);this.action=b;$(this.getId()).insert({bottom:'<div class="toolbarSpacer"></div><div class="toolbarSwitchButton" style="" id="toolbar_renamePages" title="Benennt alle Seiten in der angezeigten Reihenfolge neu"> </div>'});Event.observe($("toolbar_renamePages"),"click",b.renamePages.bind(b))}});de.edirom.server.source.RenamePagesAction=Class.create(de.edirom.server.main.Action,{initialize:function($super,a,b){$super();this.facsimileContent=b},renamePages:function(){this.facsimileContent.renamePages()}});de.edirom.server.source.Structure=Class.create(de.edirom.server.main.Content,{initialize:function($super,a){$super(a,"content_source_informationView_structure")},load:function($super){if(!this.isLoaded()){new Ajax.Updater(this.id,"/source/InformationView/xql/structure.xql",{method:"get",onComplete:function(a){$super();this.init()}.bind(this)})}},init:function(){var c=this.view.getModule().getSource();var a=c.getMovements();this.scrollview=new de.edirom.server.Scrollview("structure_list_container",true);this.scrollview.setVerticalScrolling(true);for(var b=0;b<a.length;++b){this.addMovement(a[b])}this.addListeners();this.buildSortableList()},addMovement:function(b){var g=this.view.getModule().getSource();var f=$("sourceStructure");var d=$("sourceStructureTemplate");var a=this.view.getModule().getCommandController();var e=d.cloneNode(true);e.setAttribute("id","sourceStructure_mdiv_"+b.id);e.setAttribute("onmouseover","$('delete_sourceStructure_mdiv_"+b.id+"').show();");e.setAttribute("onmouseout","$('delete_sourceStructure_mdiv_"+b.id+"').hide();");e.getElementsByClassName("deleteButton")[0].setAttribute("id","delete_sourceStructure_mdiv_"+b.id);e.getElementsByClassName("mdivBox")[0].setAttribute("id","mdivBox_"+b.id);e.getElementsByClassName("mdivName")[0].setAttribute("id",b.id);e.getElementsByClassName("mdivName")[0].setAttribute("value",b.getName());e.getElementsByClassName("mdivBars")[0].update(b.countBars());f.appendChild(e);var c=b.id;Event.observe($(b.id),"keyup",function(i,h){window.setTimeout(this.inputFieldChanged.bind(this,h,b,"name",$(b.id).value,b.id),600)}.bindAsEventListener(this,a,b.id));Event.observe($("delete_sourceStructure_mdiv_"+b.id),"click",this.deleteMovement.bindAsEventListener(this,g,b,a));b.addListener(new de.edirom.server.data.DataListener(function(j){var h=j.getSource();var i=$("sourceStructure_mdiv_"+h.id);if(j.field=="name"){$(h.id).value=j.getValue()}else{if(j.type==de.edirom.server.data.DataEvent.TYPE_ADDED&&j.field=="bar"){i.getElementsByClassName("mdivBars")[0].update(h.countBars())}else{if(j.type==de.edirom.server.data.DataEvent.TYPE_REMOVED&&j.field=="bar"){i.getElementsByClassName("mdivBars")[0].update(h.countBars())}}}}));if(this.scrolltable){this.scrolltable.refresh()}},addListeners:function(){var a=this.view.getModule().getSource();a.addListener(new de.edirom.server.data.DataListener(function(d){if(d.type==de.edirom.server.data.DataEvent.TYPE_REMOVED&&d.field=="movement"){$("sourceStructure").removeChild($("sourceStructure_mdiv_"+d.getValue()));this.buildSortableList();if(this.scrollview){this.scrollview.refresh()}}else{if(d.type==de.edirom.server.data.DataEvent.TYPE_ADDED&&d.field=="movement"){this.addMovement(d.getSource().getMovement(d.getValue()));this.buildSortableList();if(this.scrollview){this.scrollview.refresh(0,1000000)}}else{if(d.type==de.edirom.server.data.DataEvent.TYPE_MODIFIED&&d.field=="movement"){var b=$("sourceStructure_mdiv_"+d.getValue());$("sourceStructure").removeChild(b);var c=d.getSource().getMovementAfter(d.getValue())==null?null:$("sourceStructure_mdiv_"+d.getSource().getMovementAfter(d.getValue()).id);$("sourceStructure").insertBefore(b,c);this.buildSortableList()}}}}.bind(this)));Event.observe($("addMovement"),"click",this.createMovement.bind(this))},buildSortableList:function(){Sortable.create("sourceStructure",{elements:$$("#sourceStructure .sourceStructure_mdiv"),ghosting:true,tag:"div",format:/^sourceStructure_mdiv_(.*)$/,onUpdate:this.sortOrderUpdated.bind(this)});this.sortOrder=Sortable.sequence("sourceStructure")},sortOrderUpdated:function(){var e=Sortable.sequence("sourceStructure");if(de.edirom.areArraysEqual(e,this.sortOrder)){return}var d="";var f="";for(var c=0;c<this.sortOrder.length;c++){var b=e.indexOf(this.sortOrder[c]);if(c!=b&&c!=b+1&&c!=b-1){d=this.sortOrder[c];f=(b==0)?null:e[b-1];break}}if(d==""){for(var c=0;c<this.sortOrder.length;c++){var b=e.indexOf(this.sortOrder[c]);if(c!=b){d=this.sortOrder[c];f=(b==0)?null:e[b-1];break}}}this.sortOrder=e;var g=this.view.getModule().getSource();var a=this.view.getModule().getCommandController();a.addCommand(new de.edirom.server.main.MoveObjectCommand(g,"movements",d,f))},createMovement:function(){var d="edirom_mdiv_"+Math.uuid().toLowerCase();var c=this.view.getModule().getSource();var a=this.view.getModule().getCommandController();var b=new de.edirom.server.data.Movement(d,"unbenannt",c);a.addCommand(new de.edirom.server.main.AddObjectCommand(c,"movements",b))},deleteMovement:function(b,a,c,f){var e=new de.edirom.server.main.GroupCommand();var i=c.getBars();var g=c.getLastBar();while(g!=null&&g!==false){e.addGroupCommand(new de.edirom.server.main.RemoveObjectCommand(c,"bars",g));g=c.getBarBefore(g.id)}e.addGroupCommand(new de.edirom.server.main.RemoveObjectCommand(a,"movements",c));if(i.length>0){var d=function(){f.addCommand(e);new Ajax.Request("../source/xql/deleteMdivReferencesInWorks.xql",{method:"post",parameters:{sourceID:a.id,mdivID:c.id}})}.bind(this);var h="Satz löschen";var k='Wenn Sie den Satz "'+c.getName()+'" löschen, werden gleichzeitig '+i.length+" darin enthaltene Takte gelöscht.";var j={firstButton:"Abbrechen",secondButton:"Satz löschen",secondFunc:d};(new de.edirom.server.main.Popup(k,j,h)).showPopup()}else{f.addCommand(e)}},inputFieldChanged:function(b,c,e,d,a){if(typeof this.inputFieldChanges=="undefined"){this.inputFieldChanges=new Array()}if(typeof this.inputFieldChanges[e]=="undefined"){this.inputFieldChanges[e]="undefined"}if(this.inputFieldChanges[e]!=d&&$(a).value==d&&c.name!=d){b.addCommand(new de.edirom.server.main.ChangeFieldCommand(c,e,d));this.inputFieldChanges[e]=d}},setVisible:function($super,a){$super(a);if(this.scrollview){this.scrollview.refresh()}}});de.edirom.server.source.Facsimile=Class.create(de.edirom.server.main.Content,{clickMode:"",barsVisible:false,barsPositionsDirty:true,barsRendered:false,marquee:null,initialize:function($super,a){$super(a,"content_source_facsimileView_facsimile");this.source=a.module.source;this.shortcutController=a.module.getShortcutController()},setVisible:function($super,a){$super(a);if(a){this.shortcutController.addShortcutListener("content","content.facsimile",this.shortcutListener.bind(this))}else{this.shortcutController.removeShortcutListener("content","content.facsimile")}},load:function($super){if(!this.isLoaded()){new Ajax.Updater(this.id,"/source/FacsimileView/xql/facsimiles.xql",{method:"get",parameters:{id:$("sourceId").value},onComplete:function(){$super();this.sidebar=new de.edirom.server.main.Sidebar(this.id);this.init();this.facsimileMarkSidebarContent=new de.edirom.server.source.FacsimileMarkSidebarContent(this.sidebar.getContentContainerId(),this);this.sidebar.addContent(this.facsimileMarkSidebarContent);this.facsimileMarkAction=new de.edirom.server.source.FacsimileMarkAction(this.view.toolbarGroup,this.sidebar,this.facsimileMarkSidebarContent)}.bind(this)})}},init:function(){this.addListeners();this.viewer=new de.edirom.server.main.FacsimileViewer($("imageContainer"),this.source.getPagesAsMap());this.bindListeners();if(typeof this.facsimileToLoad!="undefined"&&this.facsimileToLoad!=null){var c=this.facsimileToLoad;this.facsimileToLoad=null;this.loadFacsimile(c)}else{var b=this.view.getModule().getSource();var a=b.getFirstPage();if(a!=null){this.loadFacsimile(a)}}},getCommandController:function(){return this.view.getModule().getCommandController()},addListeners:function(){Event.observe($("toolbar_zoomInput"),"keyup",this.updateZoom.bind(this));Event.observe($("toolbar_zoomSmaller"),"click",this.updateZoom.bindAsEventListener(this,-1));Event.observe($("toolbar_zoomLarger"),"click",this.updateZoom.bindAsEventListener(this,1));Event.observe($("toolbar_pageInput"),"keyup",this.updateFacsimile.bind(this));Event.observe($("toolbar_prevPage"),"click",this.prevDigilibImage.bind(this));Event.observe($("toolbar_nextPage"),"click",this.nextDigilibImage.bind(this))},bindListeners:function(){this.viewer.addZoomListener(this.zoomChanged.bind(this));this.viewer.addOffsetListener(this.offsetChanged.bind(this));this.viewer.addMouseDownListener(this.mouseDownListener.bind(this))},loadFacsimile:function(a){this.preLoadFacsimile();this.viewer.loadFacsimile(a.id);this.postLoadFacsimile(a)},preLoadFacsimile:function(){if(typeof this.viewer!="undefined"&&typeof this.viewer.getFacsimileId()!="undefined"){this.source.getPage(this.viewer.getFacsimileId()).removeListeners("facsimileView_facsimile")}var a=this.barsVisible;if(this.facsimileMarkSidebarContent){this.resetFacsimileMarkSidebar()}this.removeBars()},resetFacsimileMarkSidebar:function(){if(this.facsimileMarkSidebarContent.activeBar!=""&&this.facsimileMarkSidebarContent.focussed==0){if(this.marquee!=null){this.marquee.resetMarquee(this.facsimileMarkSidebarContent.activeBar);this.facsimileMarkSidebarContent.toggleClickMode(this,"editBar")}else{this.facsimileMarkSidebarContent.hideBarDetails()}}},postLoadFacsimile:function(b){$("toolbar_pageInput").value=b.getName();this.source.getPage(this.viewer.getFacsimileId()).addListener(new de.edirom.server.data.DataListener("facsimileView_facsimile",function(d){if(d.field=="bar"&&d.type==de.edirom.server.data.DataEvent.TYPE_ADDED){var c=this.source.getBar(d.getValue());this.renderBar(c,this.barsVisible)}else{if(d.field=="bar"&&d.type==de.edirom.server.data.DataEvent.TYPE_REMOVED){var c=this.source.getBar(d.getValue());this.removeBar(c)}}}.bind(this)));var a=this.barsVisible;if(a){this.showBars()}if(this.sidebar.checkVisible()){this.sidebar.getActiveContent().reload()}},zoomChanged:function(a){$("toolbar_zoomInput").value=Math.round(a*100)+"%";if(this.barsVisible){var b=this.source.getPage(this.viewer.getFacsimileId()).getBarIDs();b=this.source.getBars(b);this.setBarsSizes(b)}else{this.barsPositionsDirty=!this.barsVisible}if(this.marquee!=null){this.marquee.updateMarqueePosition();this.marquee.recalculateMarqueeZoom()}},offsetChanged:function(b,a){if(this.barsVisible){this.setBarsPositions(b,a)}else{this.barsPositionsDirty=!this.barsVisible}if(this.marquee!=null){this.marquee.updateMarqueePosition()}},updateZoom:function(c,b){if(c.keyCode==Event.KEY_RETURN||typeof b!="undefined"){var a=$("toolbar_zoomInput").value.replace("%","").replace(".","_").strip();this.viewer.updateZoom(a,b)}},mouseDownListener:function(a){if(a.shiftKey&&$("facsimileMarkSidebarContent").visible()){this.facsimileMarkSidebarContent.createBar();this.facsimileMarkSidebarContent.toggleClickMode(this.facsimileMarkSidebarContent,"editBar");this.marquee.initDragWithoutEvent(this.marquee.getId(),Event.pointerX(a),Event.pointerY(a))}},updateFacsimile:function(c){if(c.keyCode==Event.KEY_RETURN){var b=this.view.getModule().getSource();var a=b.findPage($("toolbar_pageInput").value.strip());if(a!=null){this.loadFacsimile(a)}}},nextDigilibImage:function(){if(this.viewer.hasNextFacsimile()){this.preLoadFacsimile();var a=this.viewer.nextFacsimile();this.postLoadFacsimile(a)}},prevDigilibImage:function(){if(this.viewer.hasPrevFacsimile()){this.preLoadFacsimile();var a=this.viewer.prevFacsimile();this.postLoadFacsimile(a)}},showPage:function(a){var c=this.view.getModule().getSource();var b=c.getPage(a);if(b!=null&&this.isLoaded()){this.loadFacsimile(b)}else{if(b!=null){this.facsimileToLoad=b}}},setBarsSizes:function(a){this.barsPositionsDirty=false;a.each(function(d){var f=Math.round(d.top*this.viewer.getZoom());var e=Math.round(d.left*this.viewer.getZoom());var c=Math.round(d.width*this.viewer.getZoom());var b=Math.round(d.height*this.viewer.getZoom());this.setBarPosAndSize(d.id,e,f,c,b)}.bind(this))},setBarPosAndSize:function(e,a,d,b,c){if($("measure_hi_"+e)){$("measure_hi_"+e).setStyle({top:d+"px",left:a+"px",width:b+"px",height:c+"px"});$("measureContentFrame_"+e).setStyle({top:(Math.round(c/2)-10+d)+"px",left:a+"px",width:b+"px"});if(!$("measureBox_"+e).visible()&&d>-1&&a>-1&&b>0&&c>0){$("measureBox_"+e).show()}}},setBarsPositions:function(b,a){this.barsPositionsDirty=false;$("measures").setStyle({top:a+"px",left:b+"px"})},setBarsVisibility:function(a){this.barsVisible=a;if(a){this.showBars()}else{this.hideBars()}},showBars:function(){var a=this.source.getPage(this.viewer.getFacsimileId()).getBarIDs();a=this.source.getBars(a);if(this.barsRendered&&this.barsPositionsDirty){this.setBarsSizes(a);this.setBarsPositions(this.viewer.getOffX(),this.viewer.getOffY())}if(this.barsRendered){a.each(function(b){if(b.getTop()>-1&&b.getLeft()>-1&&b.getWidth()>0&&b.getHeight()>0){$("measureBox_"+b.id).show()}}.bind(this))}else{this.renderBars(a,true)}},hideBars:function(){var a=this.source.getPage(this.viewer.getFacsimileId()).getBarIDs();a.each(function(b){$("measureBox_"+b).hide()}.bind(this))},removeBars:function(){if(!this.barsRendered){return}this.barsRendered=false;$("measures").update();var a=this.source.getPage(this.viewer.getFacsimileId()).getBarIDs();a=this.source.getBars(a);a.each(function(b){b.removeListeners("facsimileView_facsimile")})},removeBar:function(a){if(!this.barsRendered){return}a.removeListeners("facsimileView_facsimile");$("measure_hi_"+a.id).remove();$("measureContentFrame_"+a.id).remove()},renderBars:function(a,b){a.each(function(d,c){this.renderBar(c,d)}.bind(this,b));this.barsRendered=true},renderBar:function(c,f){var e=Math.round(c.top*this.viewer.getZoom());var d=Math.round(c.left*this.viewer.getZoom());var b=Math.round(c.width*this.viewer.getZoom());var a=Math.round(c.height*this.viewer.getZoom());$("measures").insert({bottom:'<div id="measure_hi_'+c.id+'" class="measureHi" style="display: none; top:'+e+"px; left:"+d+"px; width: "+b+"px; height: "+a+'px;"/>'});$("measures").insert({bottom:'<div id="measureContentFrame_'+c.id+'" class="measureContentFrame" style="top: '+(Math.round(a/2)-10+e)+"px; left:"+d+"px;width: "+b+'px;"/>'});$("measureContentFrame_"+c.id).insert({bottom:'<div id="measureBox_'+c.id+'" class="measureBox" style="display: none;"/>'});$("measureBox_"+c.id).insert({bottom:'<div id="measure_'+c.id+'" class="measure" title="Takt '+c.name+" ("+this.source.getMovement(c.getPartId()).getName()+')">'+c.name+"</div>"});$("measureContentFrame_"+c.id).insert({bottom:'<div id="annotBox_'+c.id+'" class="annotBox" style="max-width: '+b+'px;display: none;"/>'});this.setBarsPositions(this.viewer.getOffX(),this.viewer.getOffY());c.addListener(new de.edirom.server.data.DataListener("facsimileView_facsimile",function(i){if(i.field=="name"&&i.type==de.edirom.server.data.DataEvent.TYPE_MODIFIED){$("measure_"+i.getSource().id).update(i.getValue());$("measure_"+i.getSource().id).title="Takt "+i.getValue()+" ("+this.source.getMovement(i.getSource().getPartId()).getName()+")"}else{if(i.field=="partId"&&i.type==de.edirom.server.data.DataEvent.TYPE_MODIFIED){$("measure_"+i.getSource().id).title="Takt "+i.getSource().getName()+" ("+this.source.getMovement(i.getSource().getPartId()).getName()+")"}else{if((i.field=="top"||i.field=="left"||i.field=="width"||i.field=="height")&&i.type==de.edirom.server.data.DataEvent.TYPE_MODIFIED){var k=Math.round(i.getSource().top*this.viewer.getZoom());var j=Math.round(i.getSource().left*this.viewer.getZoom());var h=Math.round(i.getSource().width*this.viewer.getZoom());var g=Math.round(i.getSource().height*this.viewer.getZoom());this.setBarPosAndSize(i.getSource().id,j,k,h,g)}}}}.bind(this)));Event.observe($("measure_"+c.id),"mouseover",this.highlightBar.bindAsEventListener(this,c));Event.observe($("measure_"+c.id),"mouseout",this.deHighlightBar.bindAsEventListener(this,c));Event.observe($("measure_"+c.id),"click",this.barClicked.bindAsEventListener(this,c));Event.observe($("measure_"+c.id),"dblclick",this.barDblClicked.bindAsEventListener(this,c));if(f&&c.getTop()>-1&&c.getLeft()>-1&&c.getWidth()>0&&c.getHeight()>0){$("measureBox_"+c.id).show()}},highlightBar:function(b,a){$("measure_hi_"+a.id).show()},deHighlightBar:function(b,a){if($("measure_hi_"+a.id)){$("measure_hi_"+a.id).hide()}},barClicked:function(b,a){if($("facsimileMarkSidebarContent").visible()){if(this.clickMode=="selectBars"){this.facsimileMarkSidebarContent.showBarDetails(b,a)}}},barDblClicked:function(b,a){if($("facsimileMarkSidebarContent").visible()){this.facsimileMarkSidebarContent.showBarDetails(b,a);if(this.facsimileMarkSidebarContent.activeBar!=""){this.facsimileMarkSidebarContent.toggleClickMode(this.facsimileMarkSidebarContent,"editBar")}if(this.clickMode=="selectBars"){}}},setClickMode:function(b){if(this.clickMode=="editBar"&&b!="editBar"){this.destroyMarquee()}this.clickMode=b;if(b=="editBar"){var a=this.facsimileMarkSidebarContent.activeBar;this.createMarquee(a)}},resetFacsimileView:function(){if(typeof this.viewer!="undefined"){this.viewer.resetFacsimileView()}},shortcutListener:function(){return false},createMarquee:function(a){this.marquee=new de.edirom.server.source.Marquee(this,a);this.marquee.init()},destroyMarquee:function(){if(this.marquee!=null){this.marquee.destroy()}this.marquee=null}});de.edirom.server.source.FacsimileMarkToolbarItem=Class.create(de.edirom.server.main.ToolbarItem,{initialize:function($super,a,b){$super(a);this.action=b;$(a.getId()).insert({bottom:'<div class="toolbarButton" id="toolbar_toggleMarking"></div>'});Event.observe($("toolbar_toggleMarking"),"click",b.toggleVisibility.bindAsEventListener(b))}});de.edirom.server.source.FacsimileMarkAction=Class.create(de.edirom.server.main.Action,{initialize:function($super,b,c,a){$super();this.sidebar=c;this.sidebarContent=a;this.toolbarItem=new de.edirom.server.source.FacsimileMarkToolbarItem(b,this);this.sidebarContent.addVisibilityChangeRequestedListener(new de.edirom.server.main.VisibilityChangeRequestedListener(function(d){if(d){$("toolbar_toggleMarking").addClassName("toggled")}else{$("toolbar_toggleMarking").removeClassName("toggled")}}))},toggleVisibility:function(){this.sidebarContent.load();this.sidebarContent.loadBars();var a=this.sidebarContent.facsimile.view.showBarsAction;var b=a.changeBarVisibility.bind(a);if(this.sidebar.activeContent==this.sidebarContent){if(!a.keepVisible&&a.barsVisible){b()}else{a.keepVisible=false}Event.observe($("toolbar_showBars"),"click",a.changeBarVisibility.bind(a))}else{if(a.barsVisible){a.keepVisible=true}else{b()}$("toolbar_showBars").stopObserving("click")}this.sidebar.toggleSidebarContent(this.sidebarContent)}});de.edirom.server.source.FacsimileMarkSidebarContent=Class.create(de.edirom.server.main.SidebarContent,{visibilityChangeRequestedListeners:new Array(),visibilityChangedListeners:new Array(),activeBar:"",initialize:function($super,a,b){$super(a,"facsimileMarkSidebarContent");this.facsimile=b;this.source=this.facsimile.source;this.controller=this.facsimile.getCommandController();this.focusable=["barZones","movementSelection","barNumber","barUpbeat","barRest","barRestNumber"];this.focussed=0;this.pageListener=null},load:function($super){if(!this.isLoaded()){$super();$("sidebarZones").hide();this.addVisibilityChangedListener(new de.edirom.server.main.VisibilityChangedListener(function(d){if(d){if(!this.barZonesScrolltable){this.barZonesScrolltable=new de.edirom.server.Scrolltable("barZones_container","barZones",false);this.barZonesScrolltable.setVerticalScrolling(true)}else{this.barZonesScrolltable.refresh()}this.setBarsInListListeners()}}.bind(this)));var b="";var a=this.source.getMovements();for(var c=0;c<a.length;c++){b+='<option value="'+a[c].id+'">'+a[c].getName()+"</option>"}$("movementSelection").insert({bottom:b});$("movementSelection").value=a[0].id;this.toggleClickMode(null,"selectBars");this.setListeners()}},reload:function($super){$super();this.loadBars();this.hideBarDetails()},show:function($super){$super();this.toggleClickMode(null,"selectBars");this.facsimile.shortcutController.addShortcutListener("sidebarContent","sidebarContent.facsimileMark",this.shortcutListener.bind(this))},hide:function($super){$super();this.facsimile.shortcutController.removeShortcutListener("sidebarContent","sidebarContent.facsimileMark")},setListeners:function(){Event.observe($("tool_createBar"),"click",function(a){if(a.altKey){this.createBar(this.guessBarCoords())}else{this.createBar()}}.bindAsEventListener(this));Event.observe($("tool_deleteBar"),"click",this.deleteBar.bind(this));Event.observe($("tool_editBar"),"click",this.toggleClickMode.bindAsEventListener(this,"editBar"));Event.observe($("movementSelection"),"change",this.updateBarObject.bindAsEventListener(this,"movement"));Event.observe($("barNumber"),"keyup",this.updateBarObject.bindAsEventListener(this,"name"));Event.observe($("barNumber"),"focus",this.setFocus.bind(this,"barNumber"));Event.observe($("barNumber"),"blur",this.setFocus.bind(this,"barNumber"));Event.observe($("barRestNumber"),"focus",this.setFocus.bind(this,"barRestNumber"));Event.observe($("barRestNumber"),"blur",this.setFocus.bind(this,"barRestNumber"));Event.observe($("barUpbeat"),"change",this.updateBarObject.bindAsEventListener(this,"upbeat"));Event.observe($("barRest"),"click",this.updateBarObject.bindAsEventListener(this,"rest"));Event.observe($("barRestNumber"),"keyup",this.updateBarObject.bindAsEventListener(this,"restNumber"));Event.observe($("barRest"),"click",function(){if($("barRest").checked){$("barRestNumber").enable()}else{$("barRestNumber").disable();$("barRestNumber").value=""}}.bindAsEventListener(this,"rest"))},setFocus:function(a){if(a=="barNumber"){(this.focussed==1)?this.focussed=0:this.focussed=1}if(a=="barRestNumber"){(this.focussed==2)?this.focussed=0:this.focussed=2}},shortcutListener:function(e){var d=(navigator.userAgent.indexOf("Macintosh")!=-1);var c=e.keyCode||e.which||e.button;switch(c){case 8:case 46:if(this.activeBar!=""&&this.focussed==0){this.deleteBar();return true}break;case 13:if(this.activeBar!=""&&((this.activeBar.getWidth()!=-1&&this.activeBar.getHeight()!=-1&&this.activeBar.getLeft()!=-1&&this.activeBar.getTop()!=-1)||this.facsimile.marquee!=null)){var a=false;if(this.facsimile.marquee!=null){a=true}this.toggleClickMode(this,"editBar");if(a){this.hideBarDetails()}return true}break;case 27:if(this.activeBar!=""&&this.focussed==0){if(this.facsimile.marquee!=null){this.facsimile.marquee.resetMarquee(this.activeBar);this.toggleClickMode(this,"editBar");return true}else{this.hideBarDetails()}return true}break;case 37:if(this.facsimile.marquee!=null){this.facsimile.marquee.moveLeft(e.shiftKey?10:1,e.ctrlKey);return true}else{if(this.focussed==0){var b=this.source.getPage(this.facsimile.viewer.getFacsimileId()).getBarIDs();if(b.length>0){if(this.activeBar==""){this.showBarDetails(e,this.source.getBar(b.last()));return true}else{var f=b.indexOf(this.activeBar.id);if(f>0){this.showBarDetails(e,this.source.getBar(b[f-1]));return true}}}}}break;case 38:if(this.facsimile.marquee!=null){this.facsimile.marquee.moveTop(e.shiftKey?10:1,e.ctrlKey);return true}else{var b=this.source.getPage(this.facsimile.viewer.getFacsimileId()).getBarIDs();if(b.length>0){if(this.activeBar==""){this.showBarDetails(e,this.source.getBar(b.last()));return true}else{var f=b.indexOf(this.activeBar.id);if(f>0){this.showBarDetails(e,this.source.getBar(b[f-1]));return true}}}}break;case 39:if(this.facsimile.marquee!=null){this.facsimile.marquee.moveRight(e.shiftKey?10:1,e.ctrlKey);return true}else{if(this.focussed==0){var b=this.source.getPage(this.facsimile.viewer.getFacsimileId()).getBarIDs();if(b.length>0){if(this.activeBar==""){this.showBarDetails(e,this.source.getBar(b.first()));return true}else{var f=b.indexOf(this.activeBar.id);if(f>=0&&f+1<b.length){this.showBarDetails(e,this.source.getBar(b[f+1]));return true}}}}}break;case 40:if(this.facsimile.marquee!=null){this.facsimile.marquee.moveBottom(e.shiftKey?10:1,e.ctrlKey);return true}else{var b=this.source.getPage(this.facsimile.viewer.getFacsimileId()).getBarIDs();if(b.length>0){if(this.activeBar==""){this.showBarDetails(e,this.source.getBar(b.first()));return true}else{var f=b.indexOf(this.activeBar.id);if(f>=0&&f+1<b.length){this.showBarDetails(e,this.source.getBar(b[f+1]));return true}}}}break;case 78:if(e.shiftKey&&e.altKey){this.createBar(this.guessBarCoords());return true}else{if(e.shiftKey){this.createBar();return true}}break;case 83:if((d&&e.metaKey)|(!d&&e.ctrlKey)){this.facsimile.view.module.doSave();return true}break}return false},loadBars:function(){$$("tr.listedBar").each(function(c){c.remove()});if(this.pageListener!=null){var a=this.pageListener.pageId;var b=this.pageListener.listener;this.source.getPage(a).removeListener(b)}this.source.getPage(this.facsimile.viewer.getFacsimileId()).getBarIDs().each(function(c){this.addBarToList(c);this.setBarInListListener(c)}.bind(this));this.sortBarList();$("currentPage").update(this.source.getPage(this.facsimile.viewer.getFacsimileId()).name);this.pageListener={pageId:this.facsimile.viewer.getFacsimileId(),listener:new de.edirom.server.data.DataListener(function(c){if(c.field=="bar"&&c.type==de.edirom.server.data.DataEvent.TYPE_ADDED){this.addBarToList(c.getValue());this.setBarInListListener(c.getValue());this.sortBarList()}else{if(c.field=="bar"&&c.type==de.edirom.server.data.DataEvent.TYPE_REMOVED){this.removeBarFromList(c.getValue())}}}.bind(this))};this.source.getPage(this.facsimile.viewer.getFacsimileId()).addListener(this.pageListener.listener);if(this.barZonesScrolltable){this.barZonesScrolltable.refreshTable()}},createBar:function(c){var a="edirom_measure_"+Math.uuid().toLowerCase();var b="edirom_zone_"+Math.uuid().toLowerCase();var h=this.facsimile.viewer.getFacsimileId();var g=$("movementSelection").value;var i=this.getMovementID(h);if(g!=i){g=i;$("movementSelection").value=g}var d=this.getNextBarNumber(g);var f=new de.edirom.server.data.Bar(a,d,-1,-1,-1,-1,g,0,false,h,b);if(c!=null){f.setTop(c.top);f.setLeft(c.left);f.setWidth(c.width);f.setHeight(c.height)}var e=new de.edirom.server.main.GroupCommand();e.addGroupCommand(new de.edirom.server.main.AddObjectCommand(this.source.getMovement(g),"bars",f));e.addGroupCommand(new de.edirom.server.main.AddObjectCommand(this.source.getPage(this.facsimile.viewer.getFacsimileId()),"bars",f.id));this.controller.addCommand(e);this.showBarDetails(null,f);this.barZonesScrolltable.refreshTable();this.barZonesScrolltable.refresh(0,1000000)},getMovementID:function(a){var c=$("movementSelection").value;var d=this.source.getPage(a).getBarIDs();if(d.length==0){var b=this.source.getPageBefore(a);if(b!=null){c=this.getMovementID(b.id)}}else{c=this.source.getBar(d.last()).getPartId()}return c},getNextBarNumber:function(d){var c=0;var b=this.source.getMovement(d).bars.getLast();if(b!=null){var a=b.getName();if(!isNaN(a)){c=Number(a)}if(b.getRest()>1){return c+Number(b.getRest())}else{if(b.getUpbeat()){return c}}}return c+1},deleteBar:function(){if(this.activeBar==""){return false}var e=this.activeBar;var h=e.id;var b=e.getName();var f=e.getPartId();var d=function(){this.hideBarDetails();var i=new de.edirom.server.main.GroupCommand();i.addGroupCommand(new de.edirom.server.main.RemoveObjectCommand(this.source.getPage(this.facsimile.viewer.getFacsimileId()),"bars",e.id));i.addGroupCommand(new de.edirom.server.main.RemoveObjectCommand(this.source.getMovement(f),"bars",e));this.controller.addCommand(i);this.barZonesScrolltable.refreshTable();this.barZonesScrolltable.refresh();new Ajax.Request("../source/xql/deleteBarReferencesInWorks.xql",{method:"post",parameters:{sourceID:this.source.id,measureID:h}})}.bind(this);var g="Takt löschen";var c='Wenn Sie Takt "'+b+'" löschen, werden dadurch automatisch in allen Werken, die "'+this.source.getName()+'" referenzieren, die Verweise auf diesen Takt aufgehoben. Dies betrifft sowohl Taktkonkordanz als auch Anmerkungen.';var a={firstButton:"Abbrechen",secondButton:"Takt löschen",secondFunc:d};(new de.edirom.server.main.Popup(c,a,g)).showPopup()},addBarToList:function(b){var a=this.source.getBar(b);var c='<tr id="tr_'+a.id+'" class="listedBar"><td class="name">'+a.getName()+'</td><td class="offset">'+a.getTop()+" / "+a.getLeft()+'</td><td class="width">'+a.getWidth()+'</td><td class="height">'+a.getHeight()+"</td></tr>";$("barZones_tbody").insert({bottom:c})},sortBarList:function(){var b=this.source.getPage(this.facsimile.viewer.getFacsimileId()).getBarIDs();var a=this.source.getBarsSorted(b);for(var c=0;c<a.length;c++){$("barZones_tbody").insert({bottom:$("tr_"+a[c].id)})}},setBarInListListener:function(c){var b=this.source.getBar(c);var a=function(d,e){this.showBarDetails(d,e);if(this.activeBar!=""){this.toggleClickMode(this,"editBar")}}.bind(this);Event.observe($("tr_"+b.id),"mouseover",this.highlightBarList.bindAsEventListener(this,b));Event.observe($("tr_"+b.id),"mouseout",this.deHighlightBarList.bindAsEventListener(this,b));Event.observe($("tr_"+b.id),"click",this.showBarDetails.bindAsEventListener(this,b));Event.observe($("tr_"+b.id),"dblclick",a.bindAsEventListener(this,b));b.addListener(new de.edirom.server.data.DataListener("facsimileView_facsimileMark",function(d){switch(d.getField()){case"name":$$("#tr_"+d.getSource().id+" .name").each(function(e){e.title=d.getValue();e.update(d.getValue())});break;case"top":$$("#tr_"+d.getSource().id+" .offset").each(function(e){e.update(d.getValue()+" / "+d.getSource().getLeft())});break;case"left":$$("#tr_"+d.getSource().id+" .offset").each(function(e){e.update(d.getSource().getTop()+" / "+d.getValue())});break;case"width":$$("#tr_"+d.getSource().id+" .width").each(function(e){e.update(d.getValue())});break;case"height":$$("#tr_"+d.getSource().id+" .height").each(function(e){e.update(d.getValue())});break;case"partId":this.sortBarList();break}}.bind(this)))},setBarsInListListeners:function(){var b=$("barZones_tbody").childElements();for(var a=0;a<b.length;a++){this.setBarInListListener(b[a].readAttribute("id").substring(3))}},removeBarFromList:function(b){if(this.activeBar==this.source.getBar(b)){this.hideBarDetails()}var a=$("tr_"+b);$("barZones_tbody").removeChild(a);this.source.getBar(b).removeListeners("facsimileView_facsimileMark")},showBarDetails:function(b,a){this.hideBarDetails();if(!$("sidebarZones").visible()){$("sidebarZones").show()}this.activeBar=a;$("tr_"+a.id).addClassName("marked");this.facsimile.highlightBar(b,a);this.barZonesScrolltable.focusElement("tr_"+a.id,"center");$("movementSelection").value=a.getPartId();$("barNumber").value=a.getName();$("barUpbeat").checked=a.getUpbeat();$("barRest").checked=a.getRest()>0;$("barRestNumber").value=(a.getRest()>0)?a.getRest():"";if($("barRest").checked){$("barRestNumber").enable()}else{$("barRestNumber").disable()}this.activeBarListener=new de.edirom.server.data.DataListener(function(c){switch(c.field){case"name":$("barNumber").value=c.getValue();break;case"upbeat":$("barUpbeat").checked=c.getValue();break;case"rest":$("barRest").checked=c.getValue()>0;$("barRestNumber").value=(c.getValue()>0)?c.getValue():"";break}});a.addListener(this.activeBarListener);if($("tr_"+a.id)){$("tr_"+a.id).addClassName("markedBar")}this.facsimile.sidebar.scrollview.refresh()},hideBarDetails:function(){if($("sidebarZones").visible()){$("sidebarZones").hide()}if(this.activeBar!=""){this.activeBar.removeListener(this.activeBarListener);$("tr_"+this.activeBar.id).removeClassName("marked");this.facsimile.deHighlightBar(null,this.activeBar)}this.activeBar="";$("barNumber").value="";$("barUpbeat").checked=false;$("barRest").checked=false;$("barRestNumber").value="";$$("tr.markedBar").each(function(a){a.removeClassName("markedBar")});this.toggleClickMode(null,"selectBars");this.facsimile.sidebar.scrollview.refresh()},highlightBarList:function(b,a){$("tr_"+a.id).addClassName("highlighted");if(a.getWidth()!=-1&&a.getHeight()!=-1&&a.getLeft()!=-1&&a.getTop()!=-1){this.facsimile.highlightBar(b,a)}},deHighlightBarList:function(b,a){$("tr_"+a.id).removeClassName("highlighted");if(a.getWidth()!=-1&&a.getHeight()!=-1&&a.getLeft()!=-1&&a.getTop()!=-1){this.facsimile.deHighlightBar(b,a)}},toggleClickMode:function(a,b){if(b==this.facsimile.clickMode){if(b=="editBar"&&this.facsimile.marquee!=null){this.updateBarCoords(this.facsimile.marquee.marqueeLeft,this.facsimile.marquee.marqueeTop,this.facsimile.marquee.marqueeWidth,this.facsimile.marquee.marqueeHeight)}if(b!="selectBars"){$("tool_"+b).removeClassName("active")}if(this.facsimile.clickMode!="selectBars"){this.toggleClickMode(null,"selectBars")}return false}if(b!="selectBars"){$("tool_"+b).addClassName("active")}this.facsimile.setClickMode(b)},guessBarCoords:function(){var g=this.facsimile.viewer.getFacsimileId();var i=this.source.getPage(g).getBarIDs();var j=0;var h=0;var e=0;var b;i.each(function(l){if(this.source.getBar(l).getHeight()>0){e++;j+=this.source.getBar(l).getHeight();h+=this.source.getBar(l).getWidth();b=l}});var f=this.facsimile.viewer.getFacsimileWidth(0);var d=this.facsimile.viewer.getFacsimileHeight(0);var c=new Object;if(e!=0){c.height=Math.round(j/e);c.width=Math.round(h/e);var a=this.source.getBar(b);var k=this.source.getBar(i.first());if(f-(a.getLeft()+a.getWidth())>=c.width){c.left=a.getLeft()+a.getWidth()-Math.round(c.width*0.05);c.top=a.getTop()}else{if(d-(a.getTop()+a.getHeight())>=c.height){c.left=k.getLeft();c.top=a.getTop()+a.getHeight()}else{c.height=Math.round(d*0.2);c.width=Math.round(f*0.2);c.left=Math.round(f*0.7);c.top=Math.round(d*0.7)}}}else{c.height=Math.round(d*0.35);c.width=Math.round(f*0.2);c.left=Math.round(f*0.1);c.top=Math.round(d*0.1)}return c},updateBarCoords:function(b,e,c,a){if(b==this.activeBar.getLeft()&&e==this.activeBar.getTop()&&c==this.activeBar.getWidth()&&a==this.activeBar.getHeight()){return}if(c<=0||a<=0){return}var d=new de.edirom.server.main.GroupCommand();if(b!=this.activeBar.getLeft()){d.addGroupCommand(new de.edirom.server.main.ChangeFieldCommand(this.activeBar,"left",b))}if(e!=this.activeBar.getTop()){d.addGroupCommand(new de.edirom.server.main.ChangeFieldCommand(this.activeBar,"top",e))}if(c!=this.activeBar.getWidth()){d.addGroupCommand(new de.edirom.server.main.ChangeFieldCommand(this.activeBar,"width",c))}if(a!=this.activeBar.getHeight()){d.addGroupCommand(new de.edirom.server.main.ChangeFieldCommand(this.activeBar,"height",a))}this.controller.addCommand(d)},updateBarObject:function(c,a){switch(a){case"name":window.setTimeout(this.inputFieldChanged.bind(this,this.controller,this.activeBar,"name",$("barNumber").value,"barNumber"),200);break;case"upbeat":this.controller.addCommand(new de.edirom.server.main.ChangeFieldCommand(this.activeBar,"upbeat",$("barUpbeat").checked));break;case"rest":this.controller.addCommand(new de.edirom.server.main.ChangeFieldCommand(this.activeBar,"rest",this.getBarRestNumber()));break;case"restNumber":this.controller.addCommand(new de.edirom.server.main.ChangeFieldCommand(this.activeBar,"rest",this.getBarRestNumber()));break;case"movement":var f=this.activeBar.getPartId();var b=$("movementSelection").value;var d=new de.edirom.server.main.GroupCommand();d.addGroupCommand(new de.edirom.server.main.RemoveObjectCommand(this.source.getMovement(f),"bars",this.activeBar));d.addGroupCommand(new de.edirom.server.main.AddObjectCommand(this.source.getMovement(b),"bars",this.activeBar));this.controller.addCommand(d);break}},getBarRestNumber:function(){if(!$("barRest").checked){return 0}var a=$("barRestNumber").value.trim();if(isNaN(a)){$("barRestNumber").value=1}else{$("barRestNumber").value=Math.max(1,a)}return $("barRestNumber").value},inputFieldChanged:function(b,c,e,d,a){if(typeof this.inputFieldChanges=="undefined"){this.inputFieldChanges=new Array()}if(typeof this.inputFieldChanges[e]=="undefined"){this.inputFieldChanges[e]="undefined"}if(this.inputFieldChanges[e]!=d&&$(a).value==d){b.addCommand(new de.edirom.server.main.ChangeFieldCommand(c,e,d));this.inputFieldChanges[e]=d}}});de.edirom.server.source.FacsimileView=Class.create(de.edirom.server.main.View,{initialize:function($super,a,b){$super(a,b);this.content=new de.edirom.server.source.Facsimile(this);this.addContent(this.content);this.toolbarGroup=new de.edirom.server.main.ToolbarGroup(a.toolbar);this.pageAction=new de.edirom.server.source.PageAction(this.toolbarGroup);this.zoomAction=new de.edirom.server.source.ZoomAction(this.toolbarGroup);this.showBarsAction=new de.edirom.server.source.ShowBarsAction(this.toolbarGroup,this.content);this.resetFacsimileViewAction=new de.edirom.server.source.ResetFacsimileViewAction(this.toolbarGroup,this.content);this.toolbarGroup.setVisible(false)},setActive:function($super,a){$super(a);this.toolbarGroup.setVisible(a);if(a){this.module.getShortcutController().addShortcutListener("view","view.facsimile",this.shortcutListener.bind(this));this.tabBar.hide();this.content.setVisible(true);$(this.content.id).setStyle({top:$("objectHeadFrame").getHeight()+"px"})}else{this.module.getShortcutController().removeShortcutListener("view","view.facsimile")}},shortcutListener:function(b){var a=(navigator.userAgent.indexOf("Macintosh")!=-1);if(b.which==83&&((a&&b.metaKey)|(!a&&b.ctrlKey))){this.module.doSave();return true}return false},showPage:function(a){this.content.showPage(a)}});de.edirom.server.source.Marquee=Class.create({marqueeTop:0,marqueeLeft:0,marqueeWidth:0,marqueeHeight:0,initialize:function(b,a){this.facsimileContent=b;this.bar=a},init:function(){this.marquee=new Marquee($("imageContainer"),this.facsimileContent);this.updateMarqueePosition();this.marquee.getMarquee().parentNode.setStyle({zIndex:101});if(this.bar.getLeft()>-1&&this.bar.getTop()>-1&&this.bar.getWidth()>0&&this.bar.getHeight()>0){this.marqueeTop=this.bar.getTop();this.marqueeLeft=this.bar.getLeft();this.marqueeWidth=this.bar.getWidth();this.marqueeHeight=this.bar.getHeight();this.marquee.setCoords(Math.round(this.marqueeLeft*this.facsimileContent.viewer.getZoom()),Math.round(this.marqueeTop*this.facsimileContent.viewer.getZoom()),Math.round(this.marqueeWidth*this.facsimileContent.viewer.getZoom()),Math.round(this.marqueeHeight*this.facsimileContent.viewer.getZoom()))}},updateMarqueePosition:function(){this.marquee.getMarquee().parentNode.setStyle({top:this.facsimileContent.viewer.getOffY()+"px",left:this.facsimileContent.viewer.getOffX()+"px",zIndex:101});this.marquee.getMarquee().parentNode.setStyle({width:Math.round(this.facsimileContent.viewer.getFacsimileWidth(0)*this.facsimileContent.viewer.getZoom())+"px",height:Math.round(this.facsimileContent.viewer.getFacsimileHeight(0)*this.facsimileContent.viewer.getZoom())+"px"})},recalculateMarqueeZoom:function(){this.marquee.setCoords(Math.round(this.marqueeLeft*this.facsimileContent.viewer.getZoom()),Math.round(this.marqueeTop*this.facsimileContent.viewer.getZoom()),Math.round(this.marqueeWidth*this.facsimileContent.viewer.getZoom()),Math.round(this.marqueeHeight*this.facsimileContent.viewer.getZoom()))},setMarqueeCoords:function(a,d,b,c){this.marqueeLeft=Math.round(a/this.facsimileContent.viewer.getZoom());this.marqueeTop=Math.round(d/this.facsimileContent.viewer.getZoom());this.marqueeWidth=Math.round(b/this.facsimileContent.viewer.getZoom());this.marqueeHeight=Math.round(c/this.facsimileContent.viewer.getZoom());this.facsimileContent.setBarPosAndSize(this.facsimileContent.facsimileMarkSidebarContent.activeBar.id,a,d,b,c)},resetMarquee:function(a){this.marqueeTop=a.getTop();this.marqueeLeft=a.getLeft();this.marqueeWidth=a.getWidth();this.marqueeHeight=a.getHeight();this.marquee.setCoords(Math.round(this.marqueeLeft*this.facsimileContent.viewer.getZoom()),Math.round(this.marqueeTop*this.facsimileContent.viewer.getZoom()),Math.round(this.marqueeWidth*this.facsimileContent.viewer.getZoom()),Math.round(this.marqueeHeight*this.facsimileContent.viewer.getZoom()))},destroy:function(){var a=this.marquee.getMarquee().parentNode;a.parentNode.removeChild(a)},getId:function(){return this.marquee.getId()},initDragWithoutEvent:function(c,a,b){this.marquee.initDragWithoutEvent(c,a,b)},moveLeft:function(a,b){this.marquee.moveLeft(a,b)},moveTop:function(a,b){this.marquee.moveTop(a,b)},moveBottom:function(a,b){this.marquee.moveBottom(a,b)},moveRight:function(a,b){this.marquee.moveRight(a,b)}});de.edirom.server.source.PageToolbarItem=Class.create(de.edirom.server.main.ToolbarItem,{initialize:function($super,a,b){$super(a);this.action=b;$(a.getId()).insert({bottom:'<span class="label">Seite:</span>'});$(a.getId()).insert({bottom:'<div class="toolbarTriangleLeft" id="toolbar_prevPage"></div>'});$(a.getId()).insert({bottom:'<input id="toolbar_pageInput" class="toolbarInput" type="text" value="" />'});$(a.getId()).insert({bottom:'<div class="toolbarTriangleRight" id="toolbar_nextPage"></div>'})}});de.edirom.server.source.PageAction=Class.create(de.edirom.server.main.Action,{initialize:function($super,a){$super();this.toolbarItem=new de.edirom.server.source.PageToolbarItem(a,this)}});de.edirom.server.source.ResetFacsimileViewToolbarItem=Class.create(de.edirom.server.main.ToolbarItem,{initialize:function($super,a,b){$super(a);this.action=b;$(a.getId()).insert({bottom:'<div class="toolbarButton" id="toolbar_resetFacsimileView"></div>'});Event.observe($("toolbar_resetFacsimileView"),"click",b.resetFacsimileView.bind(b))}});de.edirom.server.source.ResetFacsimileViewAction=Class.create(de.edirom.server.main.Action,{initialize:function($super,a,b){$super();this.facsimileContent=b;this.toolbarItem=new de.edirom.server.source.ResetFacsimileViewToolbarItem(a,this)},resetFacsimileView:function(){this.facsimileContent.resetFacsimileView()}});de.edirom.server.source.ShowBarsToolbarItem=Class.create(de.edirom.server.main.ToolbarItem,{initialize:function($super,a,b){$super(a);this.action=b;$(a.getId()).insert({bottom:'<div class="toolbarButton" id="toolbar_showBars"></div>'});Event.observe($("toolbar_showBars"),"click",b.changeBarVisibility.bind(b))},refreshItemLabel:function(a){if(a){$("toolbar_showBars").addClassName("toggled")}else{$("toolbar_showBars").removeClassName("toggled")}}});de.edirom.server.source.ShowBarsAction=Class.create(de.edirom.server.main.Action,{initialize:function($super,a,b){$super();this.facsimileContent=b;this.toolbarItem=new de.edirom.server.source.ShowBarsToolbarItem(a,this);this.barsVisible=false;this.keepVisible=false},changeBarVisibility:function(){if(this.keepVisible){return}this.barsVisible=!this.barsVisible;this.toolbarItem.refreshItemLabel(this.barsVisible);this.facsimileContent.setBarsVisibility(this.barsVisible)}});de.edirom.server.source.ZoomToolbarItem=Class.create(de.edirom.server.main.ToolbarItem,{initialize:function($super,a,b){$super(a);this.action=b;$(a.getId()).insert({bottom:'<span class="label">Zoom:</span>'});$(a.getId()).insert({bottom:'<div class="toolbarTriangleLeft" id="toolbar_zoomSmaller"></div>'});$(a.getId()).insert({bottom:'<input id="toolbar_zoomInput" class="toolbarInput" type="text" value="" />'});$(a.getId()).insert({bottom:'<div class="toolbarTriangleRight" id="toolbar_zoomLarger"></div>'})}});de.edirom.server.source.ZoomAction=Class.create(de.edirom.server.main.Action,{initialize:function($super,a){$super();this.toolbarItem=new de.edirom.server.source.ZoomToolbarItem(a,this)}});de.edirom.server.source.XMLView=Class.create(de.edirom.server.main.View,{initialize:function($super,a,b){$super(a,b);this.toolbarGroup=new de.edirom.server.main.ToolbarGroup(a.toolbar);this.toolbarGroup.setVisible(false);de.edirom.server.source.XMLView.self=this;this.dontOpen=false},openEditor:function(){this.openEditor(null)},openEditor:function(a){if(!this.dontOpen){if(a){window.status="edirom:de.edirom.server:openEditor?uri=/db/contents/sources/"+$("sourceId").value+".xml&height=59&elementId="+a;$$("body")[0].setStyle("overflow:hidden");this.dontOpen=false}else{window.status="edirom:de.edirom.server:openEditor?uri=/db/contents/sources/"+$("sourceId").value+".xml&height=59";$$("body")[0].setStyle("overflow:hidden");this.dontOpen=false}}},closeEditor:function(){window.status="edirom:de.edirom.server:closeEditor?command=de.edirom.server.source.XMLView.doSwitch(%switch)"},switchClicked:function($super,c){if(!this.module.getCommandController().unsavedCommands()){$super(c)}else{var b="Bitte speichern Sie zuerst alle Änderungen, bevor Sie in die XML-Ansicht wechseln.";var a={firstButton:"Ok",secondButtonVisible:"false"};(new de.edirom.server.main.Popup(b,a)).showPopup()}},setActive:function($super,a){this.setActive($super,a,null)},setActive:function($super,b,a){$super(b);this.toolbarGroup.setVisible(b);this.indicator=this.getModule().getIndicator();if(b){this.tabBar.hide();this.indicator.hide();this.openEditor(a)}else{this.closeEditor();this.indicator.show()}},getActiveContentKey:function($super){return"content_source_xmlView"}});de.edirom.server.source.XMLView.self=null;de.edirom.server.source.XMLView.doSwitch=function(a){if(a){$$("body")[0].setStyle("overflow:auto")}else{de.edirom.server.source.XMLView.self.dontOpen=true;de.edirom.server.source.XMLView.self.module.setActiveView(de.edirom.server.source.XMLView.self)}};