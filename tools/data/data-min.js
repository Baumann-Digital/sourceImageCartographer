if(typeof de.edirom.server.data=="undefined"){de.edirom.server.data={}}de.edirom.server.data.Annotation=Class.create({initialize:function(g,b,e,f,a,c,d){this.id=g;this.name=b;this.plist=new de.edirom.server.main.LinkedHashMap(e);this.resp=f;this.categories=a;this.priority=c;this.content=d;this.listeners=new Array()},addObject:function(b,a){switch(b){case"participants":this.addParticipant(a);break;case"categories":this.addCategory(a);break}},removeObject:function(a,b){switch(a){case"participants":this.removeParticipant(b);break;case"categories":this.removeCategory(b);break}},moveObject:function(b,c,a){},getPrecedingObjectID:function(b,a){return null},getField:function(a){switch(a){case"name":return this.getName();break;case"resp":return this.getResp();break;case"priority":return this.getPriority();break;case"content":return this.getContent();break}},setField:function(b,a){switch(b){case"name":this.setName(a);break;case"resp":this.setResp(a);break;case"priority":this.setPriority(a);break;case"content":this.setContent(a);break}},getXQueryUpdate:function(b,a){switch(b){case"name":return'update value $mei/id("'+this.id+'")/title with "'+a+'"';break;case"priority":return'update value $mei/id("'+this.id+'")/ptr[@type eq "priority"]/@plist with "'+a+'"';break;case"content":return'update value $mei/id("'+this.id+'")/p with "'+a+'"';break}},getXQueryUpdateList:function(e,c,a,b){switch(e){case"add":switch(c){case"participants":return'(if(not(exists($mei/id("'+this.id+'")[@plist]))) then(update insert attribute {"plist"} {""} into $mei/id("'+this.id+'")) else(), update value $mei/id("'+this.id+'")/@plist with "'+this.getParticipantList()+'")';break;case"categories":return'(if(not(exists($mei/id("'+this.id+'")[./ptr[@type eq "categories"]/@plist]))) then(update insert <ptr type="categories" plist=""/> into $mei/id("'+this.id+'")) else(), update value $mei/id("'+this.id+'")/ptr[@type eq "categories"]/@plist with "'+this.getCategoriesList()+'")';break}break;case"remove":switch(c){case"participants":var d=this.getParticipantList();if(d==""){return'update delete $mei/id("'+this.id+'")/@plist'}else{return'(if(not(exists($mei//annot[@xml:id = "'+this.id+'" and @plist]))) then(update insert attribute {"plist"} {""} into $mei/id("'+this.id+'")) else(), update value $mei/id("'+this.id+'")/@plist with "'+d+'")'}break;case"categories":var d=this.getCategoriesList();if(d==""){return'update delete $mei/id("'+this.id+'")/ptr[@type eq "categories"]'}else{return'(if(not(exists($mei/id("'+this.id+'")[./ptr[@type eq "categories"]/@plist]))) then(update insert <ptr type="categories" plist=""/> into $mei/id("'+this.id+'")) else(), update value $mei/id( "'+this.id+'")/ptr[@type eq "categories"]/@plist with "'+d+'")'}break}}},addListener:function(a){this.listeners.push(a)},removeListener:function(a){this.listeners=this.listeners.without(a)},removeListeners:function(a){this.listeners.each(function(b){if(b.getContextId()==a){this.removeListener(b)}}.bind(this))},fireEvent:function(a){this.listeners.each(function(b){b.eventFired(a)})},setName:function(a){if(this.name==a){return}this.name=a;this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"name",this.name))},getName:function(){return this.name},setResp:function(a){if(this.resp==a){return}this.resp=a;this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"resp",this.resp))},getResp:function(){return this.resp},setPriority:function(a){if(this.priority==a){return}this.priority=a;this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"priority",this.priority))},getPriority:function(){return this.priority},getPriorityName:function(){return de.edirom.server.data.AnnotationPriorities.get(this.priority)},setContent:function(a){if(this.content==a){return}this.content=a;this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"content",this.content))},getContent:function(){if(this.content==null){new Ajax.Request("/data/xql/getAnnotationContent.xql",{method:"get",parameters:{id:this.id},onSuccess:function(a){this.setContent(a.responseText);return this.content}.bind(this),onFailure:function(){alert("Die gew체nschte Anmerkung konnte nicht gefunden werden")}})}else{return this.content}},addParticipant:function(a){if(!this.plist.containsKey(a.id)){this.plist.pushElement(a.id,a);this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_ADDED,"participants",a.id));return true}return false},removeParticipant:function(a){if(this.plist.containsKey(a)){this.plist.remove(a);this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_REMOVED,"participants",a));return true}return false},getParticipant:function(a){if(this.plist.containsKey(a)){return this.plist.get(a)}return false},containsParticipant:function(a){return(this.getParticipant(a)!=false)},getParticipants:function(){return this.plist},getParticipantList:function(){var c="";var a=this.plist.keys();for(var b=0;b<a.length;b++){c+=a[b]+" "}return c.trim()},getBars:function(){var a=new Array();this.plist.each(function(b){if(b.type=="measure"){a.push(b.participantID)}});return a},addCategory:function(a){if(!this.categories.include(a)){this.categories.push(a);this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_ADDED,"categories",a))}},removeCategory:function(a){if(this.categories.include(a)){this.categories=this.categories.without(a);this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_REMOVED,"categories",a))}},getCategories:function(){return this.categories},getCategoryName:function(a){return de.edirom.server.data.AnnotationPriorities.get(a)},getCategoriesList:function(){return this.categories.join(" ")},hasCategory:function(a){return this.categories.contains(a)}});de.edirom.server.data.AnnotParticipant=Class.create({initialize:function(d,a,c,b){this.id=d;this.type=a;this.page=c;this.sourceID=b},getPage:function(){return this.page},getType:function(){return this.type},getSourceID:function(){return this.sourceID}});de.edirom.server.data.AnnotationPriorities=new Hash();de.edirom.server.data.AnnotationPriorities.set("ediromAnnotPrio1","Priorit채t 1");de.edirom.server.data.AnnotationPriorities.set("ediromAnnotPrio2","Priorit채t 2");de.edirom.server.data.AnnotationPriorities.set("ediromAnnotPrio3","Priorit채t 3");de.edirom.server.data.AnnotationCategories=new Hash();de.edirom.server.data.AnnotationCategories.set("ediromDefaultCategory_Bogensetzung","Bogensetzung");de.edirom.server.data.AnnotationCategories.set("ediromDefaultCategory_VerbalInstruction","Verbal instruction");de.edirom.server.data.AnnotationCategories.set("ediromDefaultCategory_Embellishment","Embellishment");de.edirom.server.data.AnnotationCategories.set("ediromDefaultCategory_Correction","Correction");de.edirom.server.data.AnnotationCategories.set("ediromDefaultCategory_DiastematicMark","Diastematic mark");de.edirom.server.data.AnnotationCategories.set("ediromDefaultCategory_Dynamics","Dynamics");de.edirom.server.data.AnnotationCategories.set("ediromDefaultCategory_Harmony","Harmony");de.edirom.server.data.AnnotationCategories.set("ediromDefaultCategory_Rhythm","Rhythm");de.edirom.server.data.AnnotationCategories.set("ediromDefaultCategory_Articulation","Articulation");de.edirom.server.data.AnnotationCategories.set("ediromDefaultCategory_EditorialIntervention","Editorial intervention");de.edirom.server.data.AnnotationCategories.set("ediromDefaultCategory_InclusionFromA","Inclusion from A");de.edirom.server.data.AnnotationCategories.set("ediromDefaultCategory_NotationalPeculiarity","Notational peculiarity");de.edirom.server.data.AnnotationCategories.set("ediromDefaultCategory_NotationalVariant","Notational variant");de.edirom.server.data.AnnotationCategories.set("ediromDefaultCategory_NotationalImprecision","Notational imprecision");de.edirom.server.data.AnnotationCategories.set("ediromDefaultCategory_AlterationByAnalogy","Alteration by analogy");de.edirom.server.data.AnnotationCategories.set("ediromDefaultCategory_StematicRelationship","Stemmatic Relationship");de.edirom.server.data.AnnotationCategories.set("ediromDefaultCategory_SeparativeVariant","Separative Variant");de.edirom.server.data.AnnotationCategories.set("ediromDefaultCategory_ConjunctiveError","Conjunctive Error");de.edirom.server.data.AnnotationCategories.set("ediromDefaultCategory_Score","Score");de.edirom.server.data.AnnotationCategories.set("ediromDefaultCategory_Lyrics","Lyrics");de.edirom.server.data.AnnotationCategories.set("ediromDefaultCategory_Direction","Direction");de.edirom.server.data.AnnotationCategories.set("ediromDefaultCategory_Text","Text");de.edirom.server.data.AnnotationCategories.set("ediromDefaultCategory_Music","Music");de.edirom.server.data.AnnotationCategories.set("ediromDefaultCategory_Stage","Stage");de.edirom.server.data.AnnotationCategories.set("ediromDefaultCategory_Scene","Scene");if(typeof de.edirom.server.data=="undefined"){de.edirom.server.data={}}de.edirom.server.data.Bar=Class.create({initialize:function(d,b,j,g,e,k,h,f,i,c,a){this.id=d;this.name=b;this.top=j;this.left=g;this.width=e;this.height=k;this.partId=h;this.rest=f;this.upbeat=i;this.surface=c;this.facs=a;this.listeners=new Array()},getField:function(a){switch(a){case"name":return this.getName();break;case"top":return this.getTop();break;case"left":return this.getLeft();break;case"width":return this.getWidth();break;case"height":return this.getHeight();break;case"partId":return this.getPartId();break;case"rest":return this.getRest();break;case"upbeat":return this.getUpbeat();break;case"surface":return this.getSurface();break}},setField:function(b,a){switch(b){case"name":this.setName(a);break;case"top":this.setTop(a);break;case"left":this.setLeft(a);break;case"width":this.setWidth(a);break;case"height":this.setHeight(a);break;case"partId":this.setPartId(a);break;case"rest":this.setRest(a);break;case"upbeat":this.setUpbeat(a);break}},getXQueryUpdate:function(b,a){switch(b){case"name":return'update value $mei/id("'+this.id+'")/@n with "'+a+'"';break;case"top":return'update value $mei/id($mei/id("'+this.id+'")/@facs)/@uly with "'+a+'"';break;case"left":return'update value $mei/id($mei/id("'+this.id+'")/@facs)/@ulx with "'+a+'"';break;case"width":return'update value $mei/id($mei/id("'+this.id+'")/@facs)/@lrx with "'+(this.getLeft()+a)+'"';break;case"height":return'update value $mei/id($mei/id("'+this.id+'")/@facs)/@lry with "'+(this.getTop()+a)+'"';break;case"rest":if(a==0){return'update delete $mei/id("'+this.id+'")/mrest | $mei/id("'+this.id+'")/multirest'}else{if(a==1){return'(update delete $mei/id("'+this.id+'")/multirest, if(not(exists($mei/id("'+this.id+'")[./mrest]))) then (update insert <mrest/> into $mei/id("'+this.id+'"))else())'}else{if(a>1){return'(update delete $mei/id("'+this.id+'")/mrest, if(exists($mei/id("'+this.id+'")[./multirest])) then (update value $mei/id("'+this.id+'")/multirest/@num with "'+a+'") else(update insert <multirest num="'+a+'"/> into $mei/id("'+this.id+'")))'}}}break;case"upbeat":if(a){return'(if(not(exists($mei/id("'+this.id+'")[@type]))) then(update insert attribute {"type"} {""} into $mei/id("'+this.id+'")) else(),update value $mei/id("'+this.id+'")/@type with "upbeat")'}else{return'update delete $mei/id("'+this.id+'")/@type'}break}},addListener:function(a){this.listeners.push(a)},removeListener:function(a){this.listeners=this.listeners.without(a)},removeListeners:function(a){this.listeners.each(function(b){if(b.getContextId()==a){this.removeListener(b)}}.bind(this))},fireEvent:function(a){this.listeners.each(function(b){b.eventFired(a)})},setName:function(a){if(this.name==a){return}this.name=a;this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"name",this.name))},getName:function(){return this.name},setTop:function(a){if(this.top==a){return}this.top=a;this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"top",this.top))},setLeft:function(a){if(this.left==a){return}this.left=a;this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"left",this.left))},setWidth:function(a){if(this.width==a){return}this.width=a;this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"width",this.width))},setHeight:function(a){if(this.height==a){return}this.height=a;this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"height",this.height))},getTop:function(){return this.top},getLeft:function(){return this.left},getWidth:function(){return this.width},getHeight:function(){return this.height},setPartId:function(a){if(this.partId==a){return}this.partId=a;this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"partId",this.partId))},getPartId:function(){return this.partId},setRest:function(a){if(this.rest==a){return}this.rest=a;this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"rest",this.rest))},getRest:function(){return this.rest},setUpbeat:function(a){if(this.upbeat==a){return}this.upbeat=a;this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"upbeat",this.upbeat))},getUpbeat:function(){return this.upbeat},getSurface:function(){return this.surface},setSurface:function(a){if(this.surface==a){return}this.surface=a;this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"surface",this.surface))},changeBarNumber:function(c){var b=/\d+[a-z]/;var a=this.getName();if(a.match(b)){return String(Number(a.match(/\d+/))+c)+a.substr(-1)}else{return String(Number(a)+c)}}});if(typeof de.edirom.server.data=="undefined"){de.edirom.server.data={}}de.edirom.server.data.Concordance=Class.create({initialize:function(b,a){this.parent=b;this.type=a;this.concordance=new de.edirom.server.main.LinkedHashMap();this.reverseIndex={};this.listeners=new Array()},addObject:function(b,a){switch(b){case"connections":this.addConnection(a);break}},removeObject:function(a,b){switch(a){case"connections":this.removeConnection(b);break}},moveObject:function(b,c,a){},getPrecedingObjectID:function(b,a){switch(b){case"connections":return(this.concordance.getPrevious(a)==null)?null:this.concordance.getPrevious(a).id;break}},getField:function(a){},setField:function(b,a){},getXQueryUpdate:function(b,a){},getXQueryUpdateList:function(d,c,a,b){if(this.type=="mdiv"){switch(d){case"add":switch(c){case"connections":return'update insert <annot type="connection" xml:id="'+a.id+'">'+a.getParticipantList()+'</annot> into $mei//annot[@type eq "movementConcordance"]';break}break;case"move":switch(c){case"connections":return"";break}break;case"remove":switch(c){case"connections":return'update delete $mei/id("'+a+'")';break}}}else{if(this.type=="measure"){switch(d){case"add":switch(c){case"connections":return'update insert <annot type="connection" xml:id="'+a.id+'">'+a.getParticipantList()+'</annot> into $mei//annot[@type eq "measureConcordance"]';break}break;case"move":switch(c){case"connections":return"";break}break;case"remove":switch(c){case"connections":return'update delete $mei/id("'+a+'")';break}}}}},addListener:function(a){this.listeners.push(a)},removeListener:function(a){this.listeners=this.listeners.without(a)},fireEvent:function(a){this.listeners.each(function(b){b.eventFired(a)})},getType:function(){return this.type},getConnectionByParticipant:function(a){if(typeof this.reverseIndex[a]=="undefined"){return null}return this.reverseIndex[a]},getConnection:function(a){return this.concordance.get(a)},existsConnection:function(a){return this.concordance.containsKey(a)},addConnection:function(a){if(!this.concordance.containsKey(a.id)){this.concordance.pushElement(a.id,a);var b=a.getParticipants();b.each(function(c){if(typeof this.reverseIndex[c]=="undefined"){this.reverseIndex[c]=a}}.bind(this));a.addListener(new de.edirom.server.data.DataListener("concordance",this.reindexConnection.bind(this)));this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_ADDED,"connections",a));return true}return false},removeConnection:function(c){if(this.concordance.containsKey(c)){var a=this.concordance.get(c);var b=a.getParticipants();b.each(function(d){if(typeof this.reverseIndex[d]!="undefined"){delete this.reverseIndex[d]}}.bind(this));a.removeListeners("concordance");this.concordance.remove(c);this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_REMOVED,"connections",a));return true}return false},reindexConnection:function(a){if(a.getField()!="participants"){return}if(a.getType()==de.edirom.server.data.DataEvent.TYPE_ADDED){this.reverseIndex[a.getValue()]=a.getSource()}else{if(a.getType()==de.edirom.server.data.DataEvent.TYPE_REMOVED){delete this.reverseIndex[a.getValue()]}}},getConnections:function(){return this.concordance.values()}});if(typeof de.edirom.server.data=="undefined"){de.edirom.server.data={}}de.edirom.server.data.Connection=Class.create({initialize:function(b,a){this.id=b;this.participants=a;this.lines;this.listeners=new Array()},addObject:function(b,a){switch(b){case"participants":this.addParticipant(a);break}},removeObject:function(a,b){switch(a){case"participants":this.removeParticipant(b);break}},getField:function(){},setField:function(){},getXQueryUpdate:function(b,a){},getXQueryUpdateList:function(d,c,a,b){switch(d){case"add":switch(c){case"participants":return'if(not(exists($mei/id("'+this.id+'")[@type eq "connection"]/extptr[@xlink:href eq "xmldb:exist:///db/contents/sources/'+a.replace("#",".xml#")+'"])))then(update insert <extptr xlink:href="xmldb:exist:///db/contents/sources/'+a.replace("#",".xml#")+'"/> into $mei/id("'+this.id+'")[@type eq "connection"])else()';break}break;case"remove":switch(c){case"participants":return'update delete $mei/id("'+this.id+'")[@type eq "connection"]/extptr[@xlink:href eq "xmldb:exist:///db/contents/sources/'+a.replace("#",".xml#")+'"]';break}}},addListener:function(a){this.listeners.push(a)},removeListener:function(a){this.listeners=this.listeners.without(a)},removeListeners:function(a){this.listeners.each(function(b){if(b.getContextId()==a){this.removeListener(b)}}.bind(this))},fireEvent:function(a){this.listeners.each(function(b){b.eventFired(a)})},addParticipant:function(a){if(!this.participants.include(a)){this.participants.push(a);this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_ADDED,"participants",a));return true}return false},removeParticipant:function(a){if(this.participants.include(a)){this.participants=this.participants.without(a);this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_REMOVED,"participants",a));return true}return false},getParticipants:function(){return this.participants},countParticipants:function(){return this.participants.length},existsParticipant:function(a){var b=this.participants.include(a);return b},getParticipantList:function(){var b="";for(var a=0;a<this.participants.length;a++){b+='<extptr xlink:href="xmldb:exist:///db/contents/sources/'+this.participants[a].replace("#",".xml#")+'"/>'}return b},getLines:function(){return this.lines},setLines:function(a){this.lines=a}});if(typeof de.edirom.server.data=="undefined"){de.edirom.server.data={}}de.edirom.server.data.DataEvent=Class.create({initialize:function(c,a,d,b){this.source=c;this.type=a;this.field=d;this.value=b},getSource:function(){return this.source},getType:function(){return this.type},getField:function(){return this.field},getValue:function(){return this.value},});de.edirom.server.data.DataEvent.TYPE_ADDED=0;de.edirom.server.data.DataEvent.TYPE_REMOVED=1;de.edirom.server.data.DataEvent.TYPE_MODIFIED=2;if(typeof de.edirom.server.data=="undefined"){de.edirom.server.data={}}de.edirom.server.data.DataListener=Class.create({initialize:function(b,a){if(typeof b=="string"&&typeof a=="function"){this.contextId=b;this.func=a}else{if(typeof b=="function"&&typeof a=="undefined"){this.contextId="";this.func=b}}},eventFired:function(a){this.func(a)},getContextId:function(){return this.contextId}});if(typeof de.edirom.server.data=="undefined"){de.edirom.server.data={}}de.edirom.server.data.Movement=Class.create({initialize:function(b,a,c){this.id=b;this.name=a;this.source=c;this.bars=new de.edirom.server.main.LinkedHashMap();this.listeners=new Array()},addObject:function(b,a){switch(b){case"bars":this.addBar(a);break}},removeObject:function(b,a){switch(b){case"bars":this.removeBar(a);break}},moveObject:function(b,c,a){switch(b){case"bars":this.moveBar(c,a);break}},getPrecedingObjectID:function(b,a){switch(b){case"bars":return(this.bars.getPrevious(a)==null)?null:this.bars.getPrevious(a).id;break}},getField:function(a){switch(a){case"name":this.getName();break}},setField:function(b,a){switch(b){case"name":this.setName(a);break}},getXQueryUpdate:function(b,a){switch(b){case"name":return'update value $mei/id("'+this.id+'")/@n with "'+a+'"';break}},getXQueryUpdateList:function(d,c,a,b){switch(d){case"add":switch(c){case"bars":return'if(not($mei/id("'+this.id+'")[.//measure/id("'+a.id+'")])) then(if($mei/id("'+this.id+'")[not(./score)]) then(update insert <score><section/></score> into $mei/id("'+this.id+'")) else(), update insert <zone xml:id="'+a.facs+'" type="measure" ulx="'+a.getLeft()+'" uly="'+a.getTop()+'" lrx="'+Math.max(a.getLeft()+a.getWidth(),-1)+'" lry="'+Math.max(a.getTop()+a.getHeight(),-1)+'"/> into $mei/id("'+a.surface+'"), update insert <measure xml:id="'+a.id+'" n="'+a.getName()+'" facs="'+a.facs+'" '+(a.getUpbeat()?'type="upbeat"':"")+">"+(a.getRest()==1?"<mrest/>":"")+(a.getRest()>1?'<multirest num="'+a.getRest()+'"/>':"")+'</measure> into $mei/id("'+this.id+'")/score/section) else()'}break;case"move":switch(c){case"bars":if(b==null){return"(let $"+a+' := util:deep-copy($mei/id("'+a+'")) return (update delete $mei/id("'+a+'"), update insert $'+a+' preceding $mei/id("'+this.id+'")//measure[1]))'}else{return"(let $"+a+' := util:deep-copy($mei/id("'+a+'")) return (update delete $mei/id("'+a+'"), update insert $'+a+' following $mei/id("'+b+'")))'}break;return""}break;case"remove":switch(c){case"bars":return'(update delete $mei/id($mei/id("'+a+'")/@facs), update delete $mei/id("'+a+'"))';break}break}},addListener:function(a){this.listeners.push(a)},removeListener:function(a){this.listeners=this.listeners.without(a)},fireEvent:function(a){this.listeners.each(function(b){b.eventFired(a)})},setName:function(a){if(this.name==a){return}this.name=a;this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"name",this.name))},getName:function(){return this.name},addBar:function(a){if(!this.bars.containsKey(a.id)){this.bars.pushElement(a.id,a);this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_ADDED,"bar",a.id));if(a.getPartId()!=this.id){a.setPartId(this.id)}return true}return false},removeBar:function(a){if(this.bars.containsKey(a)){this.bars.remove(a);this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_REMOVED,"bar",a));return true}return false},moveBar:function(c,b){if(this.bars.containsKey(c)){var a=this.getBar(c);this.bars.remove(c);this.bars.insert(b,a.id,a);this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"bars",c));return true}return false},getBar:function(a){if(this.bars.containsKey(a)){return this.bars.get(a)}return false},getBarAfter:function(a){if(this.bars.containsKey(a)){return this.bars.getNext(a)}return false},getBarBefore:function(a){if(this.bars.containsKey(a)){return this.bars.getPrevious(a)}return false},getBars:function(){return this.bars.values()},countBars:function(){return this.bars.length},getFirstBar:function(){return this.bars.getFirst()},getLastBar:function(){return this.bars.getFirst()}});if(typeof de.edirom.server.data=="undefined"){de.edirom.server.data={}}de.edirom.server.data.Page=Class.create({initialize:function(h,d,e,a,g,c,f,b){this.id=h;this.name=d;this.width=e;this.height=a;this.fileName=g;this.date=c;this.path=f;this.href=b;this.bars=new Array();this.annotations=new Array();this.listeners=new Array()},addObject:function(b,a){switch(b){case"bars":this.addBar(a);break;case"annotations":this.addAnnotation(a);break}},removeObject:function(b,a){switch(b){case"bars":this.removeBar(a);break;case"annotations":this.removeAnnotation(a);break}},getField:function(a){switch(a){case"name":return this.getName();break;case"width":return this.getWidth();break;case"height":return this.getHeight();break;case"fileName":return this.getFileName();break;case"date":return this.getDate();break;case"path":return this.getPath();break;case"href":return this.getHref();break}},setField:function(b,a){switch(b){case"name":this.setName(a);break;case"width":this.setWidth(a);break;case"height":this.setHeight(a);break;case"fileName":this.setFileName(a);break;case"date":this.setDate(a);break;case"path":this.setPath(a);break;case"href":this.setHref(a);break}},getXQueryUpdate:function(b,a){switch(b){case"name":return'update value $mei/id("'+this.id+'")/@n with "'+a+'"';break}},getXQueryUpdateList:function(d,c,a,b){switch(d){case"add":switch(c){case"bars":return"()";break;case"annotations":return"()";break}break;case"remove":switch(c){case"bars":return"()";break;case"annotations":return"()";break}break}},addListener:function(a){this.listeners.push(a)},removeListener:function(a){this.listeners=this.listeners.without(a)},removeListeners:function(a){this.listeners.each(function(b){if(b.getContextId()==a){this.removeListener(b)}}.bind(this))},clearListeners:function(){this.listeners.clear()},fireEvent:function(a){this.listeners.each(function(b){b.eventFired(a)})},setName:function(a){if(this.name==a){return}this.name=a;this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"name",this.name))},getName:function(){return this.name},setWidth:function(a){if(this.width==a){return}this.width=a;this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"width",this.width))},getWidth:function(){return this.width},setHeight:function(a){if(this.height==a){return}this.height=a;this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"height",this.height))},getHeight:function(){return this.height},setFileName:function(a){if(this.fileName==a){return}this.fileName=a;this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"fileName",this.fileName))},getFileName:function(){return this.fileName},setDate:function(a){if(this.date==a){return}this.date=a;this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"date",this.date))},getDate:function(){return this.date},setPath:function(a){if(this.path==a){return}this.path=a;this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"path",this.path))},getPath:function(){return this.path},setHref:function(a){if(this.href==a){return}this.href=a;this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"href",this.href))},getHref:function(){return this.href},addBar:function(a){if(this.bars.indexOf(a)==-1){this.bars.push(a);this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_ADDED,"bar",a));return true}return false},removeBar:function(a){if(this.bars.indexOf(a)!=-1){this.bars=this.bars.without(a);this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_REMOVED,"bar",a));return true}return false},getBarIDs:function(){return this.bars},addAnnotation:function(a){if(this.annotations.indexOf(a)==-1){this.annotations.push(a);this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_ADDED,"annotations",a));return true}return false},removeAnnotation:function(a){if(this.annotations.indexOf(a)!=-1){this.annotations=this.annotations.without(a);this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_REMOVED,"annotations",a));return true}return false},getAnnotationIDs:function(){return this.annotations}});if(typeof de.edirom.server.data=="undefined"){de.edirom.server.data={}}de.edirom.server.data.Source=Class.create({initialize:function(sourceID,onSuccessFunc){this.id=sourceID;this.name;this.signature;this.composer;this.workName;this.dating;this.type;this.movements=new de.edirom.server.main.LinkedHashMap();this.pages=new de.edirom.server.main.LinkedHashMap();this.texts=new de.edirom.server.main.LinkedHashMap();this.listeners=new Array();this.logger=new de.edirom.server.main.Logger("de.edirom.server.data.Source",0);new Ajax.Request("../data/xql/getSource.xql",{method:"get",parameters:{id:sourceID},onSuccess:function(transport){eval(transport.responseText);window.source=this;if(typeof(onSuccessFunc)!="undefined"){onSuccessFunc(this)}}.bind(this),onFailure:function(transport){console.log("Seiten konnten nicht geladen werden: \n\n"+transport.responseText)}})},addObject:function(b,a){switch(b){case"pages":this.addPage(a);break;case"movements":this.addMovement(a);break;case"texts":this.addText(a);break}},removeObject:function(a,b){switch(a){case"pages":this.removePage(b);break;case"movements":this.removeMovement(b);break;case"texts":this.removeText(b);break}},moveObject:function(b,c,a){switch(b){case"pages":this.movePage(c,a);break;case"movements":this.moveMovement(c,a);break}},getPrecedingObjectID:function(b,a){switch(b){case"pages":return(this.pages.getPrevious(a)==null)?null:this.pages.getPrevious(a).id;break;case"movements":return(this.movements.getPrevious(a)==null)?null:this.movements.getPrevious(a).id;break}},getField:function(a){switch(a){case"name":return this.getName();break;case"signature":return this.getSignature();break;case"composer":return this.getComposer();break;case"workname":return this.getWorkName();break;case"dating":return this.getDating();break;case"type":return this.getType();break}},setField:function(b,a){switch(b){case"name":this.setName(a);break;case"signature":this.setSignature(a);break;case"composer":this.setComposer(a);break;case"workname":this.setWorkName(a);break;case"dating":this.setDating(a);break;case"type":this.setType(a);break}},getXQueryUpdate:function(b,a){switch(b){case"name":return'update value $mei/id("'+this.id+'")/titlestmt/title with "'+a+'"';break;case"composer":return'update value $mei/mei/meihead/filedesc/titlestmt/respstmt/persname[@role eq "composer"] with "'+a+'"';break;case"signature":return'update value $mei/id("'+this.id+'")/pubstmt/identifier[@type = "signature"] with "'+a+'"';break;case"workname":return'update value $mei/mei/meihead/filedesc/titlestmt/title with "'+a+'"';break;case"dating":return(a!=""?'(if(not(exists($mei/id("'+this.id+'")/pubstmt/date)))then(update insert <date>'+a+'</date> into $mei/id("'+this.id+'")/pubstmt)else(update value $mei/id("'+this.id+'")/pubstmt/date with "'+a+'"))':'(if(exists($mei/id("'+this.id+'")/pubstmt/date))then(update delete $mei/id("'+this.id+'")/pubstmt/date)else())');break;case"type":return'update value $mei/id("'+this.id+'")/classification/termlist/term[@classcode="ediromSourceTypes"] with "'+a+'"';break}},getXQueryUpdateList:function(d,c,a,b){switch(d){case"add":switch(c){case"pages":return'update insert <surface xml:id="'+a.id+'" n="'+a.getName()+'"><graphic xlink:href="'+a.getHref()+'" xml:id="edirom_graphic_'+Math.uuid().toLowerCase()+'" type="facsimile"/></surface> into $mei//music/facsimile[@source eq "'+this.id+'"]';break;case"movements":return'update insert <mdiv xml:id="'+a.id+'" n="'+a.getName()+'"/> into $mei//music/body';break;case"texts":return('if(exists($mei//notesstmt))then(update insert <annot type="ediromSourceDesc" plist="'+this.id+'" xlink:href="xmldb:exist:///db/contents/texts/'+a.id+'.xml" xml:id="'+a.id+'_desc"/> into $mei//notesstmt)else(update insert <notesstmt><annot type="ediromSourceDesc" plist="'+this.id+'" xlink:href="xmldb:exist:///db/contents/texts/'+a.id+'.xml" xml:id="'+a.id+'_desc"/></notesstmt> preceding $mei//sourcedesc)');break}break;case"move":switch(c){case"pages":if(b==null){return"(let $"+a+' := util:deep-copy($mei/id("'+a+'")) return (update delete $mei/id("'+a+'"), update insert $'+a+' preceding $mei//music/facsimile[@source eq "'+this.id+'"]/surface[1]))'}else{return"(let $"+a+' := util:deep-copy($mei/id("'+a+'")) return (update delete $mei/id("'+a+'"), update insert $'+a+' following $mei/id("'+b+'")))'}break;break;case"movements":if(b==null){return"(let $"+a+' := util:deep-copy($mei/id("'+a+'")) return (update delete $mei/id("'+a+'"), update insert $'+a+" preceding $mei//music/body/mdiv[1]))"}else{return"(let $"+a+' := util:deep-copy($mei/id("'+a+'")) return (update delete $mei/id("'+a+'"), update insert $'+a+' following $mei/id("'+b+'")))'}break;break}break;case"remove":switch(c){case"pages":return'update delete $mei/id("'+a+'")';break;case"movements":return'update delete $mei/id("'+a+'")';break;case"texts":return'update delete $mei/id("'+a+'_desc")';break}}},addListener:function(a){this.listeners.push(a)},removeListener:function(a){this.listeners=this.listeners.without(a)},fireEvent:function(a){this.listeners.each(function(b){b.eventFired(a)})},setName:function(a){if(this.name==a){return}this.name=a;this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"name",this.name))},getName:function(){return this.name},setSignature:function(a){if(this.signature==a){return}this.signature=a;this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"signature",this.signature))},getSignature:function(){return this.signature},setDating:function(a){if(this.dating==a){return}this.dating=a;this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"dating",this.dating))},getDating:function(){return this.dating},setType:function(a){if(this.type==a){return}this.type=a;this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"type",this.type))},getType:function(){return this.type},setComposer:function(a){if(this.composer==a){return}this.composer=a;this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"composer",this.composer))},getComposer:function(){return this.composer},setWorkName:function(a){if(this.workName==a){return}this.workName=a;this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"workName",this.workName))},getWorkName:function(){return this.workName},addPage:function(a){if(!this.pages.containsKey(a.id)){this.pages.pushElement(a.id,a);this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_ADDED,"page",a.id));return true}return false},removePage:function(a){if(this.pages.containsKey(a)){this.pages.remove(a);this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_REMOVED,"page",a));return true}return false},movePage:function(a,b){if(this.pages.containsKey(a)){var c=this.getPage(a);this.pages.remove(a);this.pages.insert(b,c.id,c);this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"page",a));return true}return false},getPage:function(a){if(this.pages.containsKey(a)){return this.pages.get(a)}return false},getPages:function(){return this.pages.values()},getPagesAsMap:function(){return this.pages},getFirstPage:function(){return this.pages.getFirst()},getPageAfter:function(a){return this.pages.getNext(a)},getPageBefore:function(a){return this.pages.getPrevious(a)},findPage:function(a){var b=null;this.pages.each(function(c){if(c.getName()==a){b=c;throw $break}});return b},addMovement:function(a){if(!this.movements.containsKey(a.id)){this.movements.pushElement(a.id,a);this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_ADDED,"movement",a.id));return true}return false},removeMovement:function(a){if(this.movements.containsKey(a)&&this.movements.length>1){this.movements.remove(a);this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_REMOVED,"movement",a));return true}return false},moveMovement:function(b,c){if(this.movements.containsKey(b)){var a=this.getMovement(b);this.movements.remove(b);this.movements.insert(c,a.id,a);this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"movement",b));return true}return false},getMovement:function(a){if(this.movements.containsKey(a)){return this.movements.get(a)}return false},getMovements:function(){return this.movements.values()},getMovementAfter:function(a){return this.movements.getNext(a)},getBar:function(a){if(this.movements.length<=0){return false}var b=false;this.movements.each(function(c){b=c.getBar(a);if(b!=false){throw $break}});return b},getBarAfter:function(c){var a=this.getAllBars();var d=this.getBar(c);var b=a.indexOf(d);if(a.length>=b){return a[b+1]}else{return null}},getBarBefore:function(c){var a=this.getAllBars();var d=this.getBar(c);var b=a.indexOf(d);if(b>0){return a[b-1]}else{return null}},getBars:function(c){var a=new Array();for(var b=0;b<c.length;b++){a.push(this.getBar(c[b]))}return a},getAllBars:function(){var a=new Array();this.movements.each(function(b){var c=b.getBars();a=a.concat(c)});return a},getBarsSorted:function(b){var l=new Hash();var m=new Array();for(var f=0;f<b.length;f++){var g=this.getBar(b[f]);var k=g.getPartId();if(l.get(k)=="undefined"|l.get(k)==null){l.set(k,new Array())}l.get(k).push(g)}var c=l.keys();for(var f=0;f<c.length;f++){var h=c[f];var a=l.get(k);var e=this.getMovement(k).getBars();a.sort(function(j,i){return e.indexOf(j)-e.indexOf(i)}.bind(this));for(var d=0;d<a.length;d++){m.push(a[d])}}return m},addText:function(a){if(!this.texts.containsKey(a.id)){this.texts.pushElement(a.id,a);this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_ADDED,"text",a.id));return true}return false},removeText:function(a){if(this.texts.containsKey(a)){this.texts.remove(a);this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_REMOVED,"text",a));return true}return false},moveText:function(c,a){if(this.texts.containsKey(c)){var b=this.gettext(c);this.texts.remove(c);this.texts.inser(a,b.id,b);this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"text",c));return true}return false},getText:function(a){if(this.texts.containsKey(a)){return this.texts.get(a)}return false},getTexts:function(){return this.texts.values()},getFirstText:function(){return this.texts.getFirst()},getTextAfter:function(a){return this.texts.getNext(a)},getTextBefore:function(a){return this.texts.getPrevious(a)}});if(typeof de.edirom.server.data=="undefined"){de.edirom.server.data={}}de.edirom.server.data.Text=Class.create({initialize:function(textID,onSuccessFunc){this.id=textID;this.body;this.title;this.listeners=new Array();this.logger=new de.edirom.server.main.Logger("de.edirom.server.data.Text",0);new Ajax.Request("../data/xql/getText.xql",{method:"get",parameters:{id:textID},onSuccess:function(transport){eval(transport.responseText);window.text=this;onSuccessFunc(this)}.bind(this),onFailure:function(transport){console.log("Text konnte nicht geladen werden: \n\n"+transport.responseText)}});new Ajax.Request("../data/xql/getTextBody.xql",{method:"get",parameters:{id:textID},onSuccess:function(transport){this.setText(transport.responseText)}.bind(this),onFailure:function(transport){console.log("Text konnte nicht geladen werden: \n\n"+transport.responseText)}})},getField:function(a){switch(a){case"text":return this.getText();break;case"title":return this.getTitle();break}},setField:function(b,a){switch(b){case"text":this.setText(a);break;case"title":this.setTitle(a);break}},getXQueryUpdate:function(b,a){},addListener:function(a){this.listeners.push(a)},removeListener:function(a){this.listeners=this.listeners.without(a)},fireEvent:function(a){this.listeners.each(function(b){b.eventFired(a)})},setText:function(a){if(this.body==a){return}this.body=a;this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"body",this.body))},getText:function(){return this.body},setTitle:function(a){if(this.title==a){return}this.title=a;this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"title",this.title))},getTitle:function(){return this.title}});if(typeof de.edirom.server.data=="undefined"){de.edirom.server.data={}}de.edirom.server.data.Work=Class.create({initialize:function(workID,onSuccessFunc){this.onSuccessFunc=onSuccessFunc;this.id=workID;this.title;this.composer;this.compositionDate;this.dedicatee;this.dedicationDate;this.premiereDate;this.premierePlace;this.movementConcordance=null;this.measureConcordance;this.annotationPriorities=new Hash();this.annotationCategories=new Hash();this.annotations=new de.edirom.server.main.LinkedHashMap();this.sources=new de.edirom.server.main.LinkedHashMap();this.sourcesToLoad=0;this.listeners=new Array();this.logger=new de.edirom.server.main.Logger("de.edirom.server.data.Work",0);new Ajax.Request("../data/xql/getWork.xql",{method:"get",parameters:{id:$("workId").value},onSuccess:function(transport){eval(transport.responseText);window.work=this;this.checkSourcesToLoad()}.bind(this),onFailure:function(transport){console.log("Werk konnte nicht geladen werden: \n\n"+transport.responseText)}})},checkSourcesToLoad:function(){if(this.sourcesToLoad==0){this.onSuccessFunc(this)}},reduceSourcesToLoad:function(){this.sourcesToLoad--;this.checkSourcesToLoad()},addObject:function(b,a){switch(b){case"sources":this.addSource(a);break;case"annotations":this.addAnnotation(a);break}},removeObject:function(a,b){switch(a){case"sources":this.removeSource(b);break;case"annotations":this.removeAnnotation(b);break}},moveObject:function(b,c,a){switch(b){case"sources":this.moveSource(c,a);break}},getPrecedingObjectID:function(b,a){switch(b){case"sources":return(this.sources.getPrevious(a)==null)?null:this.sources.getPrevious(a).id;break}},getField:function(a){switch(a){case"title":return this.getTitle();break;case"composer":return this.getComposer();break;case"compositionDate":return this.getCompositionDate();break;case"dedicatee":return this.getDedicatee();break;case"dedicationDate":return this.getDedicationDate();break;case"premiereDate":return this.getPremiereDate();break;case"premierePlace":return this.getPremierePlace();break}},setField:function(b,a){switch(b){case"title":this.setTitle(a);break;case"composer":this.setComposer(a);break;case"compositionDate":this.setCompositionDate(a);break;case"dedicatee":this.setDedicatee(a);break;case"dedicationDate":this.setDedicationDate(a);break;case"premiereDate":this.setPremiereDate(a);break;case"premierePlace":this.setPremierePlace(a);break}},getXQueryUpdate:function(b,a){switch(b){case"title":return'update value $mei/meicorpus/meihead[@type = "corpus"]/filedesc/titlestmt/title with "'+a+'"';break;case"composer":return'update value $mei/meicorpus/meihead[@type = "corpus"]/filedesc/titlestmt/respstmt/persname[@role eq "composer"] with "'+a+'"';break;case"compositionDate":return'update value $mei/meicorpus/meihead[@type = "corpus"]/profiledesc/creation/p[@n = "Creation"]/date with "'+a+'"';break;case"dedicatee":return'update value $mei/meicorpus/meihead[@type = "corpus"]/profiledesc/creation/p[@n = "Dedication"]/*[@type = "Dedicatee"] with "'+a+'"';break;case"dedicationDate":return'update value $mei/meicorpus/meihead[@type = "corpus"]/profiledesc/creation/p[@n = "Dedication"]/date with "'+a+'"';break;case"premiereDate":return'update value $mei/meicorpus/meihead[@type = "corpus"]/profiledesc/creation/p[@n = "Premiere"]/date with "'+a+'"';break;case"premierePlace":return'update value $mei/meicorpus/meihead[@type = "corpus"]/profiledesc/creation/p[@n = "Premiere"]/geogname with "'+a+'"';break}},getXQueryUpdateList:function(d,c,a,b){switch(d){case"add":switch(c){case"sources":return'update insert <source><extptr xlink:href="xmldb:exist:///db/contents/sources/'+a.id+'.xml"/></source> into $mei//meihead[@type eq "corpus"]//sourcedesc';break;case"annotations":return'update insert <annot xml:id="'+a.id+'" type="editorialComment"><title/><p/><ptr type="priority" plist="ediromAnnotPrio1"/></annot> into $mei//meihead[@type eq "corpus"]//annot[@type eq "criticalCommentary"]';break}break;case"move":switch(c){case"sources":if(b==null){return"(let $"+a.id+' := util:deep-copy($mei//meihead[@type eq "corpus"]//sourcedesc/source[./extptr/@xlink:href eq "xmldb:exist:///db/contents/sources/'+a.id+'.xml"]) return (update delete $mei//meihead[@type eq "corpus"]//sourcedesc/source[./extptr/@xlink:href eq "xmldb:exist:///db/contents/sources/'+a.id+'.xml"], update insert $'+a.id+' preceding $mei//meihead[@type eq "corpus"]//sourcedesc/source[1]))'}else{return"(let $"+a.id+' := util:deep-copy($mei//meihead[@type eq "corpus"]//sourcedesc/source[./extptr/@xlink:href eq "xmldb:exist:///db/contents/sources/'+a.id+'.xml"]) return (update delete $mei//meihead[@type eq "corpus"]//sourcedesc/source[./extptr/@xlink:href eq "xmldb:exist:///db/contents/sources/'+a.id+'.xml"], update insert $'+a.id+' following $mei//meihead[@type eq "corpus"]//sourcedesc/source[./extptr/@xlink:href eq "xmldb:exist:///db/contents/sources/'+b.id+'.xml"]))'}break;break}break;case"remove":switch(c){case"sources":return'update delete $mei//meihead[@type eq "corpus"]//sourcedesc/source[./extptr/@xlink:href eq "xmldb:exist:///db/contents/sources/'+a+'.xml"]';break;case"annotations":return'update delete $mei//meihead[@type eq "corpus"]//annot[@type eq "criticalCommentary"]/annot/id("'+a+'")';break}break}},addListener:function(a){this.listeners.push(a)},removeListener:function(a){this.listeners=this.listeners.without(a)},fireEvent:function(a){this.listeners.each(function(b){b.eventFired(a)})},setTitle:function(a){if(this.title==a){return}this.title=a;this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"title",this.title))},getTitle:function(){return this.title},setComposer:function(a){if(this.composer==a){return}this.composer=a;this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"composer",this.composer))},getComposer:function(){return this.composer},setCompositionDate:function(a){if(this.compositionDate==a){return}this.compositionDate=a;this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"compositionDate",this.compositionDate))},getCompositionDate:function(){return this.compositionDate},setDedicatee:function(a){if(this.dedicatee==a){return}this.dedicatee=a;this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"dedicatee",this.dedicatee))},getDedicatee:function(){return this.dedicatee},setDedicationDate:function(a){if(this.dedicationDate==a){return}this.dedicationDate=a;this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"dedicationDate",this.dedicationDate))},getDedicationDate:function(){return this.dedicationDate},setPremiereDate:function(a){if(this.premiereDate==a){return}this.premiereDate=a;this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"premiereDate",this.premiereDate))},getPremiereDate:function(){return this.premiereDate},setPremierePlace:function(a){if(this.premierePlace==a){return}this.premierePlace=a;this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"premierePlace",this.premierePlace))},getPremierePlace:function(){return this.premierePlace},getAnnotCategories:function(){return this.annotationCategories},getAnnotCategoryName:function(b){var a=this.annotationCategories.get(b);if(a==undefined){return false}else{return a}},getAnnotPriorityName:function(b){var a=this.annotationPriorities.get(b);if(a==undefined){return false}else{return a}},addSource:function(a){if(!this.sources.containsKey(a.id)){this.sources.pushElement(a.id,a);this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_ADDED,"sources",a.id));return true}return false},removeSource:function(a){if(this.sources.containsKey(a)){this.sources.remove(a);this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_REMOVED,"sources",a));return true}return false},moveSource:function(b,a){if(this.sources.containsKey(b)){var c=this.getSource(b);this.sources.remove(b);this.sources.insert(a,c.id,c);this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_MODIFIED,"sources",b));return true}return false},getSource:function(a){if(this.sources.containsKey(a)){return this.sources.get(a)}return false},getSources:function(){return this.sources.values()},getFirstSource:function(){return this.sources.getFirst()},getSourceAfter:function(a){return this.sources.getNext(a)},getSourceBefore:function(a){return this.sources.getPrevious(a)},addAnnotation:function(a){if(!this.annotations.containsKey(a.id)){this.annotations.pushElement(a.id,a);this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_ADDED,"annotations",a));return true}return false},removeAnnotation:function(a){if(this.annotations.containsKey(a)){this.annotations.remove(a);this.fireEvent(new de.edirom.server.data.DataEvent(this,de.edirom.server.data.DataEvent.TYPE_REMOVED,"annotations",a));return true}return false},getAnnotation:function(a){if(this.annotations.containsKey(a)){return this.annotations.get(a)}return false},getAnnotations:function(){return this.annotations},getAnnotationsByIDs:function(c){var b=new Array();for(var a=0;a<c.length;a++){b.push(this.getAnnotation(c[a]))}return b},checkAnnotationsPerBar:function(b){var c=this.annotations.values();for(var a=0;a<c.length;a++){if(c[a].containsParticipant(b)){return true}}return false},getAnnotationsByBarID:function(c){var b=this.annotations.values();var d=new Array;for(var a=0;a<b.length;a++){if(b[a].containsParticipant(c)){d.push(b[a])}}return d},registerParticipants:function(a){var b=this.getSource(a);if(!b){return}this.annotations.each(function(c){c.getParticipants().each(function(d){if(d.getSourceID()==a){var e=b.getPage(d.getPage());if(!e){return}e.addAnnotation(c.id+"#"+d.id)}}.bind(this))}.bind(this))}});